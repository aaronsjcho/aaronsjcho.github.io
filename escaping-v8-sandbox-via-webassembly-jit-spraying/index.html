<!DOCTYPE html>
<html lang="en">
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
    <meta name="description" content="Escaping V8 Sandbox via WebAssembly JIT Spraying (V8 &lt; 10.6.24) Escaping V8 Sandbox via WebAssembly JIT Spraying: Part 2 (11.0.4 &lt;&#x3D; V8 &lt; 12.2.170)  In this post, I will demonstrate a te">
<meta property="og:type" content="article">
<meta property="og:title" content="Escaping V8 Sandbox via WebAssembly JIT Spraying (V8 &lt; 10.6.24)">
<meta property="og:url" content="https://aaronsjcho.github.io/escaping-v8-sandbox-via-webassembly-jit-spraying/index.html">
<meta property="og:site_name" content="Aaron&#39;s Note">
<meta property="og:description" content="Escaping V8 Sandbox via WebAssembly JIT Spraying (V8 &lt; 10.6.24) Escaping V8 Sandbox via WebAssembly JIT Spraying: Part 2 (11.0.4 &lt;&#x3D; V8 &lt; 12.2.170)  In this post, I will demonstrate a te">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://aaronsjcho.github.io/escaping-v8-sandbox-via-webassembly-jit-spraying/1.png">
<meta property="og:image" content="https://aaronsjcho.github.io/escaping-v8-sandbox-via-webassembly-jit-spraying/2.png">
<meta property="og:image" content="https://aaronsjcho.github.io/escaping-v8-sandbox-via-webassembly-jit-spraying/3.png">
<meta property="og:image" content="https://aaronsjcho.github.io/escaping-v8-sandbox-via-webassembly-jit-spraying/4.png">
<meta property="og:image" content="https://aaronsjcho.github.io/escaping-v8-sandbox-via-webassembly-jit-spraying/5.png">
<meta property="og:image" content="https://aaronsjcho.github.io/escaping-v8-sandbox-via-webassembly-jit-spraying/6.png">
<meta property="og:image" content="https://aaronsjcho.github.io/escaping-v8-sandbox-via-webassembly-jit-spraying/7.png">
<meta property="og:image" content="https://aaronsjcho.github.io/escaping-v8-sandbox-via-webassembly-jit-spraying/8.png">
<meta property="og:image" content="https://aaronsjcho.github.io/escaping-v8-sandbox-via-webassembly-jit-spraying/pwn.png">
<meta property="article:published_time" content="2024-02-03T03:00:00.000Z">
<meta property="article:modified_time" content="2026-02-11T05:35:06.364Z">
<meta property="article:author" content="Seongjoon (Aaron) Cho">
<meta property="article:tag" content="browser">
<meta property="article:tag" content="chromium">
<meta property="article:tag" content="v8">
<meta property="article:tag" content="v8sbx">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://aaronsjcho.github.io/escaping-v8-sandbox-via-webassembly-jit-spraying/1.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Escaping V8 Sandbox via WebAssembly JIT Spraying (V8 &lt; 10.6.24)</title>
    <!-- async scripts -->
    <!-- Google Analytics -->

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-TXRLJ2S4LP"></script>
  <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-TXRLJ2S4LP');
  </script>


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 8.1.1"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/categories/">Category</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/escaping-v8-sandbox-via-webassembly-jit-spraying-part-2/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/escaping-the-v8-sandbox-by-overwriting-webassembly-jump-table-via-typedarray-or-arraybuffer-part-2/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://www.facebook.com/sharer.php?u=https://aaronsjcho.github.io/escaping-v8-sandbox-via-webassembly-jit-spraying/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="https://twitter.com/share?url=https://aaronsjcho.github.io/escaping-v8-sandbox-via-webassembly-jit-spraying/&text=Escaping V8 Sandbox via WebAssembly JIT Spraying (V8 &lt; 10.6.24)"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://www.linkedin.com/shareArticle?url=https://aaronsjcho.github.io/escaping-v8-sandbox-via-webassembly-jit-spraying/&title=Escaping V8 Sandbox via WebAssembly JIT Spraying (V8 &lt; 10.6.24)"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="https://pinterest.com/pin/create/bookmarklet/?url=https://aaronsjcho.github.io/escaping-v8-sandbox-via-webassembly-jit-spraying/&is_video=false&description=Escaping V8 Sandbox via WebAssembly JIT Spraying (V8 &lt; 10.6.24)"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Escaping V8 Sandbox via WebAssembly JIT Spraying (V8 &lt; 10.6.24)&body=Check out this article: https://aaronsjcho.github.io/escaping-v8-sandbox-via-webassembly-jit-spraying/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="https://getpocket.com/save?url=https://aaronsjcho.github.io/escaping-v8-sandbox-via-webassembly-jit-spraying/&title=Escaping V8 Sandbox via WebAssembly JIT Spraying (V8 &lt; 10.6.24)"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://reddit.com/submit?url=https://aaronsjcho.github.io/escaping-v8-sandbox-via-webassembly-jit-spraying/&title=Escaping V8 Sandbox via WebAssembly JIT Spraying (V8 &lt; 10.6.24)"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://www.stumbleupon.com/submit?url=https://aaronsjcho.github.io/escaping-v8-sandbox-via-webassembly-jit-spraying/&title=Escaping V8 Sandbox via WebAssembly JIT Spraying (V8 &lt; 10.6.24)"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://digg.com/submit?url=https://aaronsjcho.github.io/escaping-v8-sandbox-via-webassembly-jit-spraying/&title=Escaping V8 Sandbox via WebAssembly JIT Spraying (V8 &lt; 10.6.24)"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://www.tumblr.com/share/link?url=https://aaronsjcho.github.io/escaping-v8-sandbox-via-webassembly-jit-spraying/&name=Escaping V8 Sandbox via WebAssembly JIT Spraying (V8 &lt; 10.6.24)&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="https://news.ycombinator.com/submitlink?u=https://aaronsjcho.github.io/escaping-v8-sandbox-via-webassembly-jit-spraying/&t=Escaping V8 Sandbox via WebAssembly JIT Spraying (V8 &lt; 10.6.24)"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Setup"><span class="toc-number">1.</span> <span class="toc-text">Setup</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Analysis"><span class="toc-number">2.</span> <span class="toc-text">Analysis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Compiling-i64-const"><span class="toc-number">2.1.</span> <span class="toc-text">Compiling i64.const</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JIT-Spraying"><span class="toc-number">2.2.</span> <span class="toc-text">JIT Spraying</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Calling-WebAssembly-Function"><span class="toc-number">2.3.</span> <span class="toc-text">Calling WebAssembly Function</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exploitation"><span class="toc-number">3.</span> <span class="toc-text">Exploitation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Patch"><span class="toc-number">4.</span> <span class="toc-text">Patch</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        Escaping V8 Sandbox via WebAssembly JIT Spraying (V8 &lt; 10.6.24)
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">Seongjoon (Aaron) Cho</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-02-03T03:00:00.000Z" class="dt-published" itemprop="datePublished">2024-02-03</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/n-day/">n-day</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/browser/" rel="tag">browser</a>, <a class="p-category" href="/tags/chromium/" rel="tag">chromium</a>, <a class="p-category" href="/tags/v8/" rel="tag">v8</a>, <a class="p-category" href="/tags/v8sbx/" rel="tag">v8sbx</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <ol>
<li><strong><a href="/escaping-v8-sandbox-via-webassembly-jit-spraying/" title="Escaping V8 Sandbox via WebAssembly JIT Spraying (V8 &lt; 10.6.24)">Escaping V8 Sandbox via WebAssembly JIT Spraying (V8 &lt; 10.6.24)</a></strong></li>
<li><a href="/escaping-v8-sandbox-via-webassembly-jit-spraying-part-2/" title="Escaping V8 Sandbox via WebAssembly JIT Spraying: Part 2 (11.0.4 &lt;&#x3D; V8 &lt; 12.2.170)">Escaping V8 Sandbox via WebAssembly JIT Spraying: Part 2 (11.0.4 &lt;&#x3D; V8 &lt; 12.2.170)</a></li>
</ol>
<p>In this post, I will demonstrate a technique to escape the V8 sandbox by applying JIT spraying to WebAssembly. By manipulating the immediate constants in a WebAssembly function and redirecting execution flow, we can force the JIT compiler to emit executable shellcode into memory. This exploit assumes we have already achieved arbitrary read&#x2F;write primitives within the sandbox and focuses on crossing the sandbox boundary to achieve full remote code execution.</p>
<h2 id="Setup"><a href="#Setup" class="headerlink" title="Setup"></a>Setup</h2><ul>
<li>Ubuntu 20.04</li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://chromium.googlesource.com/v8/v8.git/+/cb5c1b8a1fd1eee214501ee06fdd4566886803c1"><code>cb5c1b8a1fd1eee214501ee06fdd4566886803c1</code></a> (Jul 26, 2022)</li>
</ul>
<p>Run <a href="v8setup.py"><code>v8setup.py</code></a> in your working directory.</p>
<h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><h3 id="Compiling-i64-const"><a href="#Compiling-i64-const" class="headerlink" title="Compiling i64.const"></a>Compiling i64.const</h3><figure class="highlight c++"><figcaption><span>src&#x2F;wasm&#x2F;function-body-decoder-impl.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">2678</span><br><span class="line">2679</span><br><span class="line">2680</span><br><span class="line">2681</span><br><span class="line">2682</span><br><span class="line">2683</span><br><span class="line">2684</span><br><span class="line">2685</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (opcode == kExprLocalGet) &#123;</span><br><span class="line">  len = WasmFullDecoder::<span class="built_in">DecodeLocalGet</span>(<span class="keyword">this</span>, opcode);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (opcode == kExprI32Const) &#123;</span><br><span class="line">  len = WasmFullDecoder::<span class="built_in">DecodeI32Const</span>(<span class="keyword">this</span>, opcode);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  OpcodeHandler handler = <span class="built_in">GetOpcodeHandler</span>(first_byte);</span><br><span class="line">  len = (*handler)(<span class="keyword">this</span>, opcode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>To decode the WebAssembly <code>i64.const</code> instruction, <code>WasmFullDecoder::DecodeFunctionBody()</code> calls <code>WasmFullDecoder::DecodeI64Const()</code>.</p>
<figure class="highlight c++"><figcaption><span>src&#x2F;wasm&#x2F;function-body-decoder-impl.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">2862</span><br><span class="line">2863</span><br><span class="line">2864</span><br><span class="line">2865</span><br><span class="line">2866</span><br><span class="line">2867</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> DECODE(name)                                                     \</span></span><br><span class="line"><span class="meta">  static int Decode##name(WasmFullDecoder* decoder, WasmOpcode opcode) &#123; \</span></span><br><span class="line"><span class="meta">    TraceLine trace_msg(decoder);                                        \</span></span><br><span class="line marked"><span class="meta">    return decoder-&gt;Decode##name##Impl(&amp;trace_msg, opcode);              \</span></span><br><span class="line"><span class="meta">  &#125;                                                                      \</span></span><br><span class="line"><span class="meta">  V8_INLINE int Decode##name##Impl(TraceLine* trace_msg, WasmOpcode opcode)</span></span><br></pre></td></tr></table></figure>

<p><code>WasmFullDecoder::DecodeI64Const()</code> calls <code>WasmFullDecoder::DecodeI64ConstImpl()</code>.</p>
<figure class="highlight c++"><figcaption><span>src&#x2F;wasm&#x2F;function-body-decoder-impl.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">3344</span><br><span class="line">3345</span><br><span class="line">3346</span><br><span class="line">3347</span><br><span class="line">3348</span><br><span class="line">3349</span><br><span class="line">3350</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">DECODE</span>(I64Const) &#123;</span><br><span class="line">  <span class="function">ImmI64Immediate&lt;validate&gt; <span class="title">imm</span><span class="params">(<span class="keyword">this</span>, <span class="keyword">this</span>-&gt;pc_ + <span class="number">1</span>)</span></span>;</span><br><span class="line">  Value value = <span class="built_in">CreateValue</span>(kWasmI64);</span><br><span class="line marked">  <span class="built_in">CALL_INTERFACE_IF_OK_AND_REACHABLE</span>(I64Const, &amp;value, imm.value);</span><br><span class="line">  <span class="built_in">Push</span>(value);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span> + imm.length;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>WasmFullDecoder::DecodeI64ConstImpl()</code> calls <code>LiftoffCompiler::I64Const()</code>.</p>
<figure class="highlight c++"><figcaption><span>src&#x2F;wasm&#x2F;baseline&#x2F;liftoff-compiler.cc</span></figcaption><table><tr><td class="gutter"><pre><span class="line">2195</span><br><span class="line">2196</span><br><span class="line">2197</span><br><span class="line">2198</span><br><span class="line">2199</span><br><span class="line">2200</span><br><span class="line">2201</span><br><span class="line">2202</span><br><span class="line">2203</span><br><span class="line">2204</span><br><span class="line">2205</span><br><span class="line">2206</span><br><span class="line">2207</span><br><span class="line">2208</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">I64Const</span><span class="params">(FullDecoder* decoder, Value* result, <span class="type">int64_t</span> value)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// The &#123;VarState&#125; stores constant values as int32_t, thus we only store</span></span><br><span class="line">  <span class="comment">// 64-bit constants in this field if it fits in an int32_t. Larger values</span></span><br><span class="line">  <span class="comment">// cannot be used as immediate value anyway, so we can also just put them in</span></span><br><span class="line">  <span class="comment">// a register immediately.</span></span><br><span class="line">  <span class="type">int32_t</span> value_i32 = <span class="built_in">static_cast</span>&lt;<span class="type">int32_t</span>&gt;(value);</span><br><span class="line">  <span class="keyword">if</span> (value_i32 == value) &#123;</span><br><span class="line">    <span class="function">__ <span class="title">PushConstant</span><span class="params">(kI64, value_i32)</span></span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    LiftoffRegister reg = __ <span class="built_in">GetUnusedRegister</span>(<span class="built_in">reg_class_for</span>(kI64), &#123;&#125;);</span><br><span class="line marked">    <span class="function">__ <span class="title">LoadConstant</span><span class="params">(reg, WasmValue(value))</span></span>;</span><br><span class="line">    <span class="function">__ <span class="title">PushRegister</span><span class="params">(kI64, reg)</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>LiftoffCompiler::I64Const()</code> calls <code>LiftoffAssembler::LoadConstant()</code> to generate instructions loading the constant <code>value</code> into <code>reg</code>.</p>
<figure class="highlight c++"><figcaption><span>src&#x2F;wasm&#x2F;baseline&#x2F;x64&#x2F;liftoff-assembler-x64.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">LiftoffAssembler::LoadConstant</span><span class="params">(LiftoffRegister reg, WasmValue value,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    RelocInfo::Mode rmode)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (value.<span class="built_in">type</span>().<span class="built_in">kind</span>()) &#123;</span><br><span class="line">    <span class="keyword">case</span> kI32:</span><br><span class="line">      <span class="keyword">if</span> (value.<span class="built_in">to_i32</span>() == <span class="number">0</span> &amp;&amp; RelocInfo::<span class="built_in">IsNoInfo</span>(rmode)) &#123;</span><br><span class="line">        <span class="built_in">xorl</span>(reg.<span class="built_in">gp</span>(), reg.<span class="built_in">gp</span>());</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">movl</span>(reg.<span class="built_in">gp</span>(), <span class="built_in">Immediate</span>(value.<span class="built_in">to_i32</span>(), rmode));</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> kI64:</span><br><span class="line">      <span class="keyword">if</span> (RelocInfo::<span class="built_in">IsNoInfo</span>(rmode)) &#123;</span><br><span class="line marked">        TurboAssembler::<span class="built_in">Move</span>(reg.<span class="built_in">gp</span>(), value.<span class="built_in">to_i64</span>());</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">movq</span>(reg.<span class="built_in">gp</span>(), <span class="built_in">Immediate64</span>(value.<span class="built_in">to_i64</span>(), rmode));</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> kF32:</span><br><span class="line">      TurboAssembler::<span class="built_in">Move</span>(reg.<span class="built_in">fp</span>(), value.<span class="built_in">to_f32_boxed</span>().<span class="built_in">get_bits</span>());</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> kF64:</span><br><span class="line">      TurboAssembler::<span class="built_in">Move</span>(reg.<span class="built_in">fp</span>(), value.<span class="built_in">to_f64_boxed</span>().<span class="built_in">get_bits</span>());</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="built_in">UNREACHABLE</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>LiftoffAssembler::LoadConstant()</code> calls <code>TurboAssembler::Move()</code> if the <code>value</code> type is <code>kI64</code>.</p>
<figure class="highlight c++"><figcaption><span>src&#x2F;codegen&#x2F;x64&#x2F;macro-assembler-x64.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Move</span><span class="params">(Register dst, <span class="type">intptr_t</span> x)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (x == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">xorl</span>(dst, dst);</span><br><span class="line">    <span class="comment">// The following shorter sequence for uint8 causes performance</span></span><br><span class="line">    <span class="comment">// regressions:</span></span><br><span class="line">    <span class="comment">// xorl(dst, dst); movb(dst,</span></span><br><span class="line">    <span class="comment">// Immediate(static_cast&lt;uint32_t&gt;(x)));</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">is_uint32</span>(x)) &#123;</span><br><span class="line">    <span class="built_in">movl</span>(dst, <span class="built_in">Immediate</span>(<span class="built_in">static_cast</span>&lt;<span class="type">uint32_t</span>&gt;(x)));</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">is_int32</span>(x)) &#123;</span><br><span class="line">    <span class="comment">// &quot;movq reg64, imm32&quot; is sign extending.</span></span><br><span class="line">    <span class="built_in">movq</span>(dst, <span class="built_in">Immediate</span>(<span class="built_in">static_cast</span>&lt;<span class="type">int32_t</span>&gt;(x)));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line marked">    <span class="built_in">movq</span>(dst, <span class="built_in">Immediate64</span>(x));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>TurboAssembler::Move()</code> calls <code>Assembler::movq()</code> for a 64-bit integer.</p>
<figure class="highlight c++"><figcaption><span>src&#x2F;codegen&#x2F;x64&#x2F;assembler-x64.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> DECLARE_INSTRUCTION(instruction)    \</span></span><br><span class="line"><span class="meta">  template <span class="string">&lt;typename... Ps&gt;</span>                 \</span></span><br><span class="line"><span class="meta">  void instruction##_tagged(Ps... ps) &#123;     \</span></span><br><span class="line"><span class="meta">    emit_##instruction(ps..., kTaggedSize); \</span></span><br><span class="line"><span class="meta">  &#125;                                         \</span></span><br><span class="line"><span class="meta">                                            \</span></span><br><span class="line"><span class="meta">  template <span class="string">&lt;typename... Ps&gt;</span>                 \</span></span><br><span class="line"><span class="meta">  void instruction##l(Ps... ps) &#123;           \</span></span><br><span class="line"><span class="meta">    emit_##instruction(ps..., kInt32Size);  \</span></span><br><span class="line"><span class="meta">  &#125;                                         \</span></span><br><span class="line"><span class="meta">                                            \</span></span><br><span class="line"><span class="meta">  template <span class="string">&lt;typename... Ps&gt;</span>                 \</span></span><br><span class="line"><span class="meta">  void instruction##q(Ps... ps) &#123;           \</span></span><br><span class="line marked"><span class="meta">    emit_##instruction(ps..., kInt64Size);  \</span></span><br><span class="line"><span class="meta">  &#125;</span></span><br><span class="line">  <span class="built_in">ASSEMBLER_INSTRUCTION_LIST</span>(DECLARE_INSTRUCTION)</span><br><span class="line"><span class="meta">#<span class="keyword">undef</span> DECLARE_INSTRUCTION</span></span><br></pre></td></tr></table></figure>

<p><code>Assembler::movq()</code> calls <code>Assembler::emit_mov()</code>.</p>
<figure class="highlight c++"><figcaption><span>src&#x2F;codegen&#x2F;x64&#x2F;assembler-x64.cc</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1673</span><br><span class="line">1674</span><br><span class="line">1675</span><br><span class="line">1676</span><br><span class="line">1677</span><br><span class="line">1678</span><br><span class="line">1679</span><br><span class="line">1680</span><br><span class="line">1681</span><br><span class="line">1682</span><br><span class="line">1683</span><br><span class="line">1684</span><br><span class="line">1685</span><br><span class="line">1686</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Assembler::emit_mov</span><span class="params">(Register dst, Immediate64 value, <span class="type">int</span> size)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">DCHECK_EQ</span>(size, kInt64Size);</span><br><span class="line">  <span class="keyword">if</span> (constpool_.<span class="built_in">TryRecordEntry</span>(value.value_, value.rmode_)) &#123;</span><br><span class="line">    <span class="comment">// Emit rip-relative move with offset = 0</span></span><br><span class="line">    Label label;</span><br><span class="line">    <span class="built_in">emit_mov</span>(dst, <span class="built_in">Operand</span>(&amp;label, <span class="number">0</span>), size);</span><br><span class="line">    <span class="built_in">bind</span>(&amp;label);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    EnsureSpace <span class="built_in">ensure_space</span>(<span class="keyword">this</span>);</span><br><span class="line">    <span class="built_in">emit_rex</span>(dst, size);</span><br><span class="line marked">    <span class="built_in">emit</span>(<span class="number">0xB8</span> | dst.<span class="built_in">low_bits</span>());</span><br><span class="line marked">    <span class="built_in">emit</span>(value);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Assembler::emit_mov()</code> emits the opcode for the 64-bit <code>mov</code> instruction followed by the raw <code>value</code>.</p>
<h3 id="JIT-Spraying"><a href="#JIT-Spraying" class="headerlink" title="JIT Spraying"></a>JIT Spraying</h3><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://en.wikipedia.org/wiki/JIT_spraying">JIT spraying</a> is an exploitation technique used to bypass the memory protection mechanism. It abuses the JIT compiler emitting immediate constants directly into the compiled code, to insert shellcode into executable memory. We can apply this technique to WebAssembly because Liftoff (the baseline compiler) emits the operand of the <code>i64.const</code> instruction directly into the compiled code, as analyzed above.<br>e</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">(module</span><br><span class="line">  (func (export &quot;f&quot;)</span><br><span class="line">    i64.const 0x4141414141414141</span><br><span class="line">    i64.const 0x4242424242424242</span><br><span class="line">    i64.const 0x4343434343434343</span><br><span class="line">    return</span><br><span class="line">  )</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>After Liftoff compiles the function <code>f</code>, we can observe the following instructions:</p>
<p><img src="/escaping-v8-sandbox-via-webassembly-jit-spraying/1.png"></p>
<p>We can insert arbitrary 8-byte constant numbers into the middle of the function code. If we can redirect the instruction pointer to the exact location of the constant, those bytes are interpreted as instructions (shellcode).</p>
<p><img src="/escaping-v8-sandbox-via-webassembly-jit-spraying/2.png"></p>
<p>Consequently, we can execute arbitrary 8-byte shellcode. However, 8 bytes is typically insufficient to execute a complex payload, such as <code>execve(&quot;/bin/sh&quot;, 0, 0)</code>. To overcome this limitation, we can chain several shellcode segments using the relative <a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.felixcloutier.com/x86/jmp"><code>jmp</code></a> instruction.</p>
<h3 id="Calling-WebAssembly-Function"><a href="#Calling-WebAssembly-Function" class="headerlink" title="Calling WebAssembly Function"></a>Calling WebAssembly Function</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">d8.<span class="property">file</span>.<span class="title function_">execute</span>(<span class="string">&quot;v8/test/mjsunit/wasm/wasm-module-builder.js&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> builder = <span class="keyword">new</span> <span class="title class_">WasmModuleBuilder</span>();</span><br><span class="line">builder.<span class="title function_">addFunction</span>(<span class="string">&quot;f&quot;</span>, <span class="title function_">makeSig</span>([], [])).<span class="title function_">addBody</span>([]).<span class="title function_">exportFunc</span>();</span><br><span class="line"><span class="keyword">let</span> instance = builder.<span class="title function_">instantiate</span>();</span><br><span class="line"></span><br><span class="line">instance.<span class="property">exports</span>.<span class="title function_">f</span>();</span><br></pre></td></tr></table></figure>

<p>The JavaScript code above creates a WebAssembly module containing an empty function, then calls the exported function.</p>
<figure class="highlight c++"><figcaption><span>src&#x2F;objects&#x2F;js-function.tq</span></figcaption><table><tr><td class="gutter"><pre><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="keyword">class</span> <span class="title class_">JSFunction</span> extends JSFunctionOrBoundFunctionOrWrappedFunction &#123;</span><br><span class="line">  shared_function_info: SharedFunctionInfo;</span><br><span class="line">  context: Context;</span><br><span class="line">  feedback_cell: FeedbackCell;</span><br><span class="line marked">  @<span class="keyword">if</span>(V8_EXTERNAL_CODE_SPACE) code: CodeDataContainer;</span><br><span class="line">  @ifnot(V8_EXTERNAL_CODE_SPACE) code: Code;</span><br><span class="line">  <span class="comment">// Space for the following field may or may not be allocated.</span></span><br><span class="line">  prototype_or_initial_map: JSReceiver|Map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/escaping-v8-sandbox-via-webassembly-jit-spraying/3.png"></p>
<p>When an exported WebAssembly function is called, the function call handler reads the address of the <code>CodeDataContainer</code> object corresponding to the function from the <code>code</code> field of the <code>Function</code> object.</p>
<figure class="highlight c++"><figcaption><span>src&#x2F;objects&#x2F;code.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Layout description.</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CODE_DATA_FIELDS(V)                                         \</span></span><br><span class="line"><span class="meta">  <span class="comment">/* Strong pointer fields. */</span>                                      \</span></span><br><span class="line"><span class="meta">  V(kPointerFieldsStrongEndOffset, 0)                               \</span></span><br><span class="line"><span class="meta">  <span class="comment">/* Weak pointer fields. */</span>                                        \</span></span><br><span class="line"><span class="meta">  V(kNextCodeLinkOffset, kTaggedSize)                               \</span></span><br><span class="line"><span class="meta">  V(kPointerFieldsWeakEndOffset, 0)                                 \</span></span><br><span class="line"><span class="meta">  <span class="comment">/* Strong Code pointer fields. */</span>                                 \</span></span><br><span class="line"><span class="meta">  V(kCodeOffset, V8_EXTERNAL_CODE_SPACE_BOOL ? kTaggedSize : 0)     \</span></span><br><span class="line"><span class="meta">  V(kCodePointerFieldsStrongEndOffset, 0)                           \</span></span><br><span class="line"><span class="meta">  <span class="comment">/* Raw data fields. */</span>                                            \</span></span><br><span class="line"><span class="meta">  V(kCodeCageBaseUpper32BitsOffset,                                 \</span></span><br><span class="line"><span class="meta">    V8_EXTERNAL_CODE_SPACE_BOOL ? kTaggedSize : 0)                  \</span></span><br><span class="line marked"><span class="meta">  V(kCodeEntryPointOffset,                                          \</span></span><br><span class="line marked"><span class="meta">    V8_EXTERNAL_CODE_SPACE_BOOL ? kExternalPointerSlotSize : 0)     \</span></span><br><span class="line"><span class="meta">  V(kFlagsOffset, V8_EXTERNAL_CODE_SPACE_BOOL ? kUInt16Size : 0)    \</span></span><br><span class="line"><span class="meta">  V(kBuiltinIdOffset, V8_EXTERNAL_CODE_SPACE_BOOL ? kInt16Size : 0) \</span></span><br><span class="line"><span class="meta">  V(kKindSpecificFlagsOffset, kInt32Size)                           \</span></span><br><span class="line"><span class="meta">  V(kUnalignedSize, OBJECT_POINTER_PADDING(kUnalignedSize))         \</span></span><br><span class="line"><span class="meta">  <span class="comment">/* Total size. */</span>                                                 \</span></span><br><span class="line"><span class="meta">  V(kSize, 0)</span></span><br></pre></td></tr></table></figure>

<p><img src="/escaping-v8-sandbox-via-webassembly-jit-spraying/4.png"></p>
<p>Next, the handler retrieves the entrypoint from the <code>CodeDataContainer</code> object and jumps to that address. This is not the WebAssembly functionâ€™s entrypoint, but rather the generic JS-to-Wasm wrapper.</p>
<figure class="highlight c++"><figcaption><span>src&#x2F;objects&#x2F;js-function.tq</span></figcaption><table><tr><td class="gutter"><pre><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="keyword">class</span> <span class="title class_">JSFunction</span> extends JSFunctionOrBoundFunctionOrWrappedFunction &#123;</span><br><span class="line marked">  shared_function_info: SharedFunctionInfo;</span><br><span class="line">  context: Context;</span><br><span class="line">  feedback_cell: FeedbackCell;</span><br><span class="line">  @<span class="keyword">if</span>(V8_EXTERNAL_CODE_SPACE) code: CodeDataContainer;</span><br><span class="line">  @ifnot(V8_EXTERNAL_CODE_SPACE) code: Code;</span><br><span class="line">  <span class="comment">// Space for the following field may or may not be allocated.</span></span><br><span class="line">  prototype_or_initial_map: JSReceiver|Map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/escaping-v8-sandbox-via-webassembly-jit-spraying/5.png"></p>
<p>The wrapper then retrieves the <code>SharedFunctionInfo</code> from the <code>Function</code> object.</p>
<figure class="highlight c++"><figcaption><span>src&#x2F;objects&#x2F;shared-function-info.tq</span></figcaption><table><tr><td class="gutter"><pre><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">@generateBodyDescriptor</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">class</span> <span class="title class_">SharedFunctionInfo</span> extends HeapObject &#123;</span><br><span class="line">  <span class="comment">// function_data field is treated as a custom weak pointer. We visit this</span></span><br><span class="line">  <span class="comment">// field as a weak pointer if there is aged bytecode. If there is no bytecode</span></span><br><span class="line">  <span class="comment">// or if the bytecode is young then we treat it as a strong pointer. This is</span></span><br><span class="line">  <span class="comment">// done to support flushing of bytecode.</span></span><br><span class="line marked">  @customWeakMarking function_data: Object;</span><br><span class="line">  name_or_scope_info: String|NoSharedNameSentinel|ScopeInfo;</span><br><span class="line">  outer_scope_info_or_feedback_metadata: HeapObject;</span><br><span class="line">  script_or_debug_info: Script|DebugInfo|Undefined;</span><br><span class="line">  <span class="comment">// [length]: The function length - usually the number of declared parameters</span></span><br><span class="line">  <span class="comment">// (always without the receiver).</span></span><br><span class="line">  <span class="comment">// Use up to 2^16-2 parameters (16 bits of values, where one is reserved for</span></span><br><span class="line">  <span class="comment">// kDontAdaptArgumentsSentinel). The value is only reliable when the function</span></span><br><span class="line">  <span class="comment">// has been compiled.</span></span><br><span class="line">  length: int16;</span><br><span class="line">  <span class="comment">// [formal_parameter_count]: The number of declared parameters (or the special</span></span><br><span class="line">  <span class="comment">// value kDontAdaptArgumentsSentinel to indicate that arguments are passed</span></span><br><span class="line">  <span class="comment">// unaltered).</span></span><br><span class="line">  <span class="comment">// In contrast to [length], formal_parameter_count includes the receiver.</span></span><br><span class="line">  formal_parameter_count: uint16;</span><br><span class="line">  function_token_offset: uint16;</span><br><span class="line">  <span class="comment">// [expected_nof_properties]: Expected number of properties for the</span></span><br><span class="line">  <span class="comment">// function. The value is only reliable when the function has been compiled.</span></span><br><span class="line">  expected_nof_properties: uint8;</span><br><span class="line">  flags2: SharedFunctionInfoFlags2;</span><br><span class="line">  flags: SharedFunctionInfoFlags;</span><br><span class="line">  <span class="comment">// [function_literal_id] - uniquely identifies the FunctionLiteral this</span></span><br><span class="line">  <span class="comment">// SharedFunctionInfo represents within its script, or -1 if this</span></span><br><span class="line">  <span class="comment">// SharedFunctionInfo object doesn&#x27;t correspond to a parsed FunctionLiteral.</span></span><br><span class="line">  function_literal_id: int32;</span><br><span class="line">  <span class="comment">// [unique_id] - For --log-maps purposes, an identifier that&#x27;s persistent</span></span><br><span class="line">  <span class="comment">// even if the GC moves this SharedFunctionInfo.</span></span><br><span class="line">  @<span class="keyword">if</span>(V8_SFI_HAS_UNIQUE_ID) unique_id: int32;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/escaping-v8-sandbox-via-webassembly-jit-spraying/6.png"></p>
<p>From there, it obtains the address of the <code>WasmExportedFunctionData</code> object.</p>
<figure class="highlight c++"><figcaption><span>src&#x2F;wasm&#x2F;wasm-objects.tq</span></figcaption><table><tr><td class="gutter"><pre><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="keyword">class</span> <span class="title class_">WasmFunctionData</span> extends HeapObject &#123;</span><br><span class="line">  <span class="comment">// The wasm-internal representation of this function object.</span></span><br><span class="line marked">  internal: WasmInternalFunction;</span><br><span class="line">  <span class="comment">// Used for calling this function from JavaScript.</span></span><br><span class="line">  @<span class="keyword">if</span>(V8_EXTERNAL_CODE_SPACE) wrapper_code: CodeDataContainer;</span><br><span class="line">  @ifnot(V8_EXTERNAL_CODE_SPACE) wrapper_code: Code;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">class</span> <span class="title class_">WasmExportedFunctionData</span> extends WasmFunctionData &#123;</span><br><span class="line">  <span class="comment">// This is the instance that exported the function (which in case of</span></span><br><span class="line">  <span class="comment">// imported and re-exported functions is different from the instance</span></span><br><span class="line">  <span class="comment">// where the function is defined -- for the latter see WasmFunctionData::ref).</span></span><br><span class="line">  instance: WasmInstanceObject;</span><br><span class="line">  function_index: Smi;</span><br><span class="line">  signature: Foreign;</span><br><span class="line">  wrapper_budget: Smi;</span><br><span class="line">  <span class="comment">// The remaining fields are for fast calling from C++. The contract is</span></span><br><span class="line">  <span class="comment">// that they are lazily populated, and either all will be present or none.</span></span><br><span class="line">  @<span class="keyword">if</span>(V8_EXTERNAL_CODE_SPACE) c_wrapper_code: CodeDataContainer;</span><br><span class="line">  @ifnot(V8_EXTERNAL_CODE_SPACE) c_wrapper_code: Code;</span><br><span class="line">  packed_args_size: Smi;</span><br><span class="line">  <span class="comment">// Functions returned by suspender.returnPromiseOnSuspend() have this field</span></span><br><span class="line">  <span class="comment">// set to the host suspender object.</span></span><br><span class="line">  suspend: Smi;  <span class="comment">// Boolean.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/escaping-v8-sandbox-via-webassembly-jit-spraying/7.png"></p>
<p>Subsequently, it accesses the <code>WasmInternalFunction</code> referenced by the <code>WasmExportedFunctionData</code> object.</p>
<figure class="highlight c++"><figcaption><span>src&#x2F;objects&#x2F;foreign.tq</span></figcaption><table><tr><td class="gutter"><pre><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="keyword">class</span> <span class="title class_">Foreign</span> extends HeapObject &#123;</span><br><span class="line marked">  foreign_address: ExternalPointer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><figcaption><span>src&#x2F;wasm&#x2F;wasm-objects.tq</span></figcaption><table><tr><td class="gutter"><pre><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This is the representation that is used internally by wasm to represent</span></span><br><span class="line"><span class="comment">// function references.</span></span><br><span class="line"><span class="comment">// The &#123;foreign_address&#125; field inherited from &#123;Foreign&#125; points to the call</span></span><br><span class="line"><span class="comment">// target.</span></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">class</span> <span class="title class_">WasmInternalFunction</span> extends Foreign &#123;</span><br><span class="line">  <span class="comment">// This is the &quot;reference&quot; value that must be passed along in the &quot;instance&quot;</span></span><br><span class="line">  <span class="comment">// register when calling the given function. It is either the target instance</span></span><br><span class="line">  <span class="comment">// (for wasm functions), or a WasmApiFunctionRef object (for functions defined</span></span><br><span class="line">  <span class="comment">// through the JS or C APIs).</span></span><br><span class="line">  <span class="comment">// For imported functions, this value equals the respective entry in</span></span><br><span class="line">  <span class="comment">// the module&#x27;s imported_function_refs array.</span></span><br><span class="line">  ref: WasmInstanceObject|WasmApiFunctionRef;</span><br><span class="line">  <span class="comment">// The external (JS) representation of this function reference.</span></span><br><span class="line">  external: JSFunction|Undefined;</span><br><span class="line">  <span class="comment">// This field is used when the call target is null.</span></span><br><span class="line">  @<span class="keyword">if</span>(V8_EXTERNAL_CODE_SPACE) code: CodeDataContainer;</span><br><span class="line">  @ifnot(V8_EXTERNAL_CODE_SPACE) code: Code;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/escaping-v8-sandbox-via-webassembly-jit-spraying/8.png"></p>
<p>Finally, it reads the call target address from the <code>WasmInternalFunction</code> object and jumps to that address, which points to the WebAssembly jump table.</p>
<p>The <code>WasmInternalFunction</code> object resides within the V8 sandbox (heap), but its <code>foreign_address</code> field points to the executable machine code (JIT page) located outside the sandbox. By overwriting this field with the address of our shellcode (which we can calculate by leaking the code address of <code>f()</code> and adding the offset to our constants) using a sandboxed arbitrary write primitive, we can hijack control flow and execute the shellcode.</p>
<h2 id="Exploitation"><a href="#Exploitation" class="headerlink" title="Exploitation"></a>Exploitation</h2><p><a href="shellcode.py"><code>shellcode.py</code></a> <a href="pwn.wat"><code>pwn.wat</code></a> <a href="pwn.js"><code>pwn.js</code></a></p>
<p><img src="/escaping-v8-sandbox-via-webassembly-jit-spraying/pwn.png"></p>
<h2 id="Patch"><a href="#Patch" class="headerlink" title="Patch"></a>Patch</h2><blockquote><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://chromium.googlesource.com/v8/v8.git/+/2eb73988a37a60520a0f8e0b1109edbcc0b91415">[sandbox] Refactor and sandboxify WasmInternalFunction::call_target</a> (Jul 26, 2022)<br>This CL refactors WasmInternalFunction to no longer inherit from Foreign but instead contain a (sandboxed) ExternalPointer field for the call target.</p>
</blockquote>

<p>The above patch moves the call target address into the external pointer table, which is located outside the V8 sandbox and referenced by an index (handle), thus preventing the direct overwrite.</p>

  </div>
</article>


    <div class="blog-post-comments">
        <div id="utterances_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/categories/">Category</a></li>
        
          <li><a href="/tags/">Tag</a></li>
        
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Setup"><span class="toc-number">1.</span> <span class="toc-text">Setup</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Analysis"><span class="toc-number">2.</span> <span class="toc-text">Analysis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Compiling-i64-const"><span class="toc-number">2.1.</span> <span class="toc-text">Compiling i64.const</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JIT-Spraying"><span class="toc-number">2.2.</span> <span class="toc-text">JIT Spraying</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Calling-WebAssembly-Function"><span class="toc-number">2.3.</span> <span class="toc-text">Calling WebAssembly Function</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exploitation"><span class="toc-number">3.</span> <span class="toc-text">Exploitation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Patch"><span class="toc-number">4.</span> <span class="toc-text">Patch</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://www.facebook.com/sharer.php?u=https://aaronsjcho.github.io/escaping-v8-sandbox-via-webassembly-jit-spraying/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="https://twitter.com/share?url=https://aaronsjcho.github.io/escaping-v8-sandbox-via-webassembly-jit-spraying/&text=Escaping V8 Sandbox via WebAssembly JIT Spraying (V8 &lt; 10.6.24)"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://www.linkedin.com/shareArticle?url=https://aaronsjcho.github.io/escaping-v8-sandbox-via-webassembly-jit-spraying/&title=Escaping V8 Sandbox via WebAssembly JIT Spraying (V8 &lt; 10.6.24)"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="https://pinterest.com/pin/create/bookmarklet/?url=https://aaronsjcho.github.io/escaping-v8-sandbox-via-webassembly-jit-spraying/&is_video=false&description=Escaping V8 Sandbox via WebAssembly JIT Spraying (V8 &lt; 10.6.24)"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Escaping V8 Sandbox via WebAssembly JIT Spraying (V8 &lt; 10.6.24)&body=Check out this article: https://aaronsjcho.github.io/escaping-v8-sandbox-via-webassembly-jit-spraying/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="https://getpocket.com/save?url=https://aaronsjcho.github.io/escaping-v8-sandbox-via-webassembly-jit-spraying/&title=Escaping V8 Sandbox via WebAssembly JIT Spraying (V8 &lt; 10.6.24)"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://reddit.com/submit?url=https://aaronsjcho.github.io/escaping-v8-sandbox-via-webassembly-jit-spraying/&title=Escaping V8 Sandbox via WebAssembly JIT Spraying (V8 &lt; 10.6.24)"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://www.stumbleupon.com/submit?url=https://aaronsjcho.github.io/escaping-v8-sandbox-via-webassembly-jit-spraying/&title=Escaping V8 Sandbox via WebAssembly JIT Spraying (V8 &lt; 10.6.24)"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://digg.com/submit?url=https://aaronsjcho.github.io/escaping-v8-sandbox-via-webassembly-jit-spraying/&title=Escaping V8 Sandbox via WebAssembly JIT Spraying (V8 &lt; 10.6.24)"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://www.tumblr.com/share/link?url=https://aaronsjcho.github.io/escaping-v8-sandbox-via-webassembly-jit-spraying/&name=Escaping V8 Sandbox via WebAssembly JIT Spraying (V8 &lt; 10.6.24)&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="https://news.ycombinator.com/submitlink?u=https://aaronsjcho.github.io/escaping-v8-sandbox-via-webassembly-jit-spraying/&t=Escaping V8 Sandbox via WebAssembly JIT Spraying (V8 &lt; 10.6.24)"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2019-2026
    Seongjoon (Aaron) Cho
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/categories/">Category</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'">


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

    <script type="text/javascript">
      var utterances_repo = 'aaronsjcho/aaronsjcho.github.io';
      var utterances_issue_term = 'pathname';
      var utterances_label = 'Comment';
      var utterances_theme = 'github-dark';

      (function(){
          var script = document.createElement('script');

          script.src = 'https://utteranc.es/client.js';
          script.setAttribute('repo', utterances_repo);
          script.setAttribute('issue-term', 'pathname');
          script.setAttribute('label', utterances_label);
          script.setAttribute('theme', utterances_theme);
          script.setAttribute('crossorigin', 'anonymous');
          script.async = true;
          var utterances_thread = document.getElementById('utterances_thread');
          if (utterances_thread) { utterances_thread.appendChild(script); }
      }());
  </script>

</body>
</html>
