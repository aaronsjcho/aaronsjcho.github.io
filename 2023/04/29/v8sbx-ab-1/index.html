<!DOCTYPE html>
<html lang="en">
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
    <meta name="description" content="In this post, I will explain an exploit technique that allows us to escape the V8 sandbox via the backing store of ArrayBuffer and WebAssembly code space. This technique leads us to arbitrary code exe">
<meta property="og:type" content="article">
<meta property="og:title" content="Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)">
<meta property="og:url" content="https://aaronsjcho.github.io/2023/04/29/v8sbx-ab-1/index.html">
<meta property="og:site_name" content="Aaron&#39;s Note">
<meta property="og:description" content="In this post, I will explain an exploit technique that allows us to escape the V8 sandbox via the backing store of ArrayBuffer and WebAssembly code space. This technique leads us to arbitrary code exe">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://aaronsjcho.github.io/2023/04/29/v8sbx-ab-1/1.png">
<meta property="og:image" content="https://aaronsjcho.github.io/2023/04/29/v8sbx-ab-1/2.png">
<meta property="og:image" content="https://aaronsjcho.github.io/2023/04/29/v8sbx-ab-1/3.png">
<meta property="og:image" content="https://aaronsjcho.github.io/2023/04/29/v8sbx-ab-1/4.png">
<meta property="og:image" content="https://aaronsjcho.github.io/2023/04/29/v8sbx-ab-1/5.png">
<meta property="og:image" content="https://aaronsjcho.github.io/2023/04/29/v8sbx-ab-1/6.png">
<meta property="og:image" content="https://aaronsjcho.github.io/2023/04/29/v8sbx-ab-1/7.png">
<meta property="og:image" content="https://aaronsjcho.github.io/2023/04/29/v8sbx-ab-1/8.png">
<meta property="og:image" content="https://aaronsjcho.github.io/2023/04/29/v8sbx-ab-1/9.png">
<meta property="og:image" content="https://aaronsjcho.github.io/2023/04/29/v8sbx-ab-1/10.png">
<meta property="og:image" content="https://aaronsjcho.github.io/2023/04/29/v8sbx-ab-1/11.png">
<meta property="og:image" content="https://aaronsjcho.github.io/2023/04/29/v8sbx-ab-1/12.png">
<meta property="og:image" content="https://aaronsjcho.github.io/2023/04/29/v8sbx-ab-1/13.png">
<meta property="og:image" content="https://aaronsjcho.github.io/2023/04/29/v8sbx-ab-1/14.png">
<meta property="og:image" content="https://aaronsjcho.github.io/2023/04/29/v8sbx-ab-1/15.png">
<meta property="og:image" content="https://aaronsjcho.github.io/2023/04/29/v8sbx-ab-1/16.png">
<meta property="og:image" content="https://aaronsjcho.github.io/2023/04/29/v8sbx-ab-1/pwn.png">
<meta property="article:published_time" content="2023-04-29T03:00:00.000Z">
<meta property="article:modified_time" content="2025-10-28T12:19:02.371Z">
<meta property="article:author" content="Seongjoon Cho">
<meta property="article:tag" content="chromium">
<meta property="article:tag" content="v8">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://aaronsjcho.github.io/2023/04/29/v8sbx-ab-1/1.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)</title>
    <!-- async scripts -->
    <!-- Google Analytics -->

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-TXRLJ2S4LP"></script>
  <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-TXRLJ2S4LP');
  </script>


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/categories/">Category</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2023/04/30/v8sbx-ab-2/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://www.facebook.com/sharer.php?u=https://aaronsjcho.github.io/2023/04/29/v8sbx-ab-1/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="https://twitter.com/share?url=https://aaronsjcho.github.io/2023/04/29/v8sbx-ab-1/&text=Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://www.linkedin.com/shareArticle?url=https://aaronsjcho.github.io/2023/04/29/v8sbx-ab-1/&title=Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="https://pinterest.com/pin/create/bookmarklet/?url=https://aaronsjcho.github.io/2023/04/29/v8sbx-ab-1/&is_video=false&description=Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)&body=Check out this article: https://aaronsjcho.github.io/2023/04/29/v8sbx-ab-1/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="https://getpocket.com/save?url=https://aaronsjcho.github.io/2023/04/29/v8sbx-ab-1/&title=Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://reddit.com/submit?url=https://aaronsjcho.github.io/2023/04/29/v8sbx-ab-1/&title=Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://www.stumbleupon.com/submit?url=https://aaronsjcho.github.io/2023/04/29/v8sbx-ab-1/&title=Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://digg.com/submit?url=https://aaronsjcho.github.io/2023/04/29/v8sbx-ab-1/&title=Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://www.tumblr.com/share/link?url=https://aaronsjcho.github.io/2023/04/29/v8sbx-ab-1/&name=Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="https://news.ycombinator.com/submitlink?u=https://aaronsjcho.github.io/2023/04/29/v8sbx-ab-1/&t=Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Setup"><span class="toc-number">1.</span> <span class="toc-text">Setup</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Analysis"><span class="toc-number">2.</span> <span class="toc-text">Analysis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Backing-store-of-ArrayBuffer"><span class="toc-number">2.1.</span> <span class="toc-text">Backing store of ArrayBuffer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Execution-flow-of-WebAssembly-function"><span class="toc-number">2.2.</span> <span class="toc-text">Execution flow of WebAssembly function</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exploitation"><span class="toc-number">3.</span> <span class="toc-text">Exploitation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Get-address-of-WebAssembly-code-space"><span class="toc-number">3.1.</span> <span class="toc-text">Get address of WebAssembly code space</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Write-shellcode-to-WebAssembly-code-space"><span class="toc-number">3.2.</span> <span class="toc-text">Write shellcode to WebAssembly code space</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Execute-shellcode"><span class="toc-number">3.3.</span> <span class="toc-text">Execute shellcode</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Patch"><span class="toc-number">4.</span> <span class="toc-text">Patch</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">Seongjoon Cho</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-04-29T03:00:00.000Z" class="dt-published" itemprop="datePublished">2023-04-29</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/N-day/">N-day</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/chromium/" rel="tag">chromium</a>, <a class="p-category" href="/tags/v8/" rel="tag">v8</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <p>In this post, I will explain an exploit technique that allows us to escape the V8 sandbox via the backing store of <code>ArrayBuffer</code> and WebAssembly code space. This technique leads us to arbitrary code execution from sandboxed exploit primitives.</p>
<h2 id="Setup"><a href="#Setup" class="headerlink" title="Setup"></a>Setup</h2><ul>
<li>Ubuntu 20.04</li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/v8/v8/commit/0ac7e1203fcb957851887fb140dc8a41139846a5"><code>0ac7e1203fcb957851887fb140dc8a41139846a5</code></a> (Feb 15, 2022)</li>
</ul>
<p>Place <a href="setup.zsh"><code>setup.zsh</code></a> and <a href="sandbox.diff"><code>sandbox.diff</code></a> in the working directory and run <code>setup.zsh</code>.</p>
<p><code>sandbox.diff</code> is identical to <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/v8/v8/commit/4a12cb1022ba335ce087dcfe31b261355524b3bf">this commit</a>, which allows us to use the memory corruption API to implement sandboxed exploit primitives.</p>
<h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><h3 id="Backing-store-of-ArrayBuffer"><a href="#Backing-store-of-ArrayBuffer" class="headerlink" title="Backing store of ArrayBuffer"></a>Backing store of ArrayBuffer</h3><p>The <a target="_blank" rel="external nofollow noopener noreferrer" href="https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer"><code>ArrayBuffer</code></a> object in JavaScript is managed by <code>JSArrayBuffer</code> class.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* src/objects/js-array-buffer.tq:14-24 */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">class</span> <span class="title class_">JSArrayBuffer</span> extends JSObject &#123;</span><br><span class="line">  byte_length: uintptr;</span><br><span class="line">  max_byte_length: uintptr;</span><br><span class="line">  <span class="comment">// A SandboxedPtr if the sandbox is enabled</span></span><br><span class="line">  backing_store: RawPtr;</span><br><span class="line">  extension: RawPtr;</span><br><span class="line">  bit_field: JSArrayBufferFlags;</span><br><span class="line">  <span class="comment">// Pads header size to be a multiple of kTaggedSize.</span></span><br><span class="line">  @<span class="keyword">if</span>(TAGGED_SIZE_8_BYTES) optional_padding: uint32;</span><br><span class="line">  @ifnot(TAGGED_SIZE_8_BYTES) optional_padding: <span class="type">void</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>JSArrayBuffer</code> has a pointer named <code>backing_store</code> that points to the memory containing the actual value stored.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> buf = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line">% <span class="title class_">DebugPrint</span>(buf);</span><br></pre></td></tr></table></figure>

<p><img src="/2023/04/29/v8sbx-ab-1/1.png"></p>
<p><img src="/2023/04/29/v8sbx-ab-1/2.png"></p>
<p>We have to use <a target="_blank" rel="external nofollow noopener noreferrer" href="https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/TypedArray"><code>TypedArray</code></a> or <a target="_blank" rel="external nofollow noopener noreferrer" href="https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/DataView"><code>DataView</code></a> to access the values stored in an <code>ArrayBuffer</code>. For example, we can store an 8-byte value with <a target="_blank" rel="external nofollow noopener noreferrer" href="https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/DataView/setBigUint64"><code>DataView.prototype.setBigUint64()</code></a>, which is managed by <code>DataViewPrototypeSetBigUint64()</code>.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* src/builtins/data-view.tq:869-877 */</span></span><br><span class="line"></span><br><span class="line"><span class="function">transitioning javascript builtin <span class="title">DataViewPrototypeSetBigUint64</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    js-implicit context: NativeContext, receiver: JSAny)</span><span class="params">(...arguments)</span>: JSAny &#123;</span></span><br><span class="line">  <span class="type">const</span> offset: JSAny = arguments[<span class="number">0</span>];</span><br><span class="line">  <span class="type">const</span> value: JSAny = arguments[<span class="number">1</span>];</span><br><span class="line">  <span class="type">const</span> isLittleEndian: JSAny = arguments[<span class="number">2</span>];</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">DataViewSet</span>(</span><br><span class="line">      context, receiver, offset, value, isLittleEndian,</span><br><span class="line">      ElementsKind::BIGUINT64_ELEMENTS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>DataViewPrototypeSetBigUint64()</code> gets into <a target="_blank" rel="external nofollow noopener noreferrer" href="https://source.chromium.org/chromium/v8/v8/+/0ac7e1203fcb957851887fb140dc8a41139846a5:src/builtins/data-view.tq;l=874"><code>DataViewSet()</code></a> → <a target="_blank" rel="external nofollow noopener noreferrer" href="https://source.chromium.org/chromium/v8/v8/+/0ac7e1203fcb957851887fb140dc8a41139846a5:src/builtins/data-view.tq;l=752"><code>StoreDataViewBigInt()</code></a> → <a target="_blank" rel="external nofollow noopener noreferrer" href="https://source.chromium.org/chromium/v8/v8/+/0ac7e1203fcb957851887fb140dc8a41139846a5:src/builtins/data-view.tq;l=668"><code>StoreDataView64()</code></a>.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* src/builtins/data-view.tq:590-624 */</span></span><br><span class="line"></span><br><span class="line"><span class="function">macro <span class="title">StoreDataView64</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    buffer: JSArrayBuffer, offset: uintptr, lowWord: uint32, highWord: uint32,</span></span></span><br><span class="line"><span class="params"><span class="function">    requestedLittleEndian: <span class="type">bool</span>)</span>: void &#123;</span></span><br><span class="line">  <span class="type">const</span> dataPointer: RawPtr = buffer.backing_store_ptr;</span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> b0: uint32 = lowWord &amp; <span class="number">0xFF</span>;</span><br><span class="line">  <span class="type">const</span> b1: uint32 = (lowWord &gt;&gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">  <span class="type">const</span> b2: uint32 = (lowWord &gt;&gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">  <span class="type">const</span> b3: uint32 = lowWord &gt;&gt;&gt; <span class="number">24</span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> b4: uint32 = highWord &amp; <span class="number">0xFF</span>;</span><br><span class="line">  <span class="type">const</span> b5: uint32 = (highWord &gt;&gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">  <span class="type">const</span> b6: uint32 = (highWord &gt;&gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">  <span class="type">const</span> b7: uint32 = highWord &gt;&gt;&gt; <span class="number">24</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (requestedLittleEndian) &#123;</span><br><span class="line">    <span class="built_in">StoreWord8</span>(dataPointer, offset, b0);</span><br><span class="line">    <span class="built_in">StoreWord8</span>(dataPointer, offset + <span class="number">1</span>, b1);</span><br><span class="line">    <span class="built_in">StoreWord8</span>(dataPointer, offset + <span class="number">2</span>, b2);</span><br><span class="line">    <span class="built_in">StoreWord8</span>(dataPointer, offset + <span class="number">3</span>, b3);</span><br><span class="line">    <span class="built_in">StoreWord8</span>(dataPointer, offset + <span class="number">4</span>, b4);</span><br><span class="line">    <span class="built_in">StoreWord8</span>(dataPointer, offset + <span class="number">5</span>, b5);</span><br><span class="line">    <span class="built_in">StoreWord8</span>(dataPointer, offset + <span class="number">6</span>, b6);</span><br><span class="line">    <span class="built_in">StoreWord8</span>(dataPointer, offset + <span class="number">7</span>, b7);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">StoreWord8</span>(dataPointer, offset, b7);</span><br><span class="line">    <span class="built_in">StoreWord8</span>(dataPointer, offset + <span class="number">1</span>, b6);</span><br><span class="line">    <span class="built_in">StoreWord8</span>(dataPointer, offset + <span class="number">2</span>, b5);</span><br><span class="line">    <span class="built_in">StoreWord8</span>(dataPointer, offset + <span class="number">3</span>, b4);</span><br><span class="line">    <span class="built_in">StoreWord8</span>(dataPointer, offset + <span class="number">4</span>, b3);</span><br><span class="line">    <span class="built_in">StoreWord8</span>(dataPointer, offset + <span class="number">5</span>, b2);</span><br><span class="line">    <span class="built_in">StoreWord8</span>(dataPointer, offset + <span class="number">6</span>, b1);</span><br><span class="line">    <span class="built_in">StoreWord8</span>(dataPointer, offset + <span class="number">7</span>, b0);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>StoreDataView64()</code> stores the value in the backing store one byte at a time.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> view = <span class="keyword">new</span> <span class="title class_">DataView</span>(buf);</span><br><span class="line">view.<span class="title function_">setBigUint64</span>(<span class="number">0</span>, <span class="number">0x4142434445464748n</span>, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure>

<p><img src="/2023/04/29/v8sbx-ab-1/3.png"></p>
<p>If we can overwrite the backing store pointer of <code>ArrayBuffer</code> with an arbitrary address, we can access that address to read from or write to.</p>
<h3 id="Execution-flow-of-WebAssembly-function"><a href="#Execution-flow-of-WebAssembly-function" class="headerlink" title="Execution flow of WebAssembly function"></a>Execution flow of WebAssembly function</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* src/wasm/wasm-code-manager.cc:2156-2222 */</span></span><br><span class="line"></span><br><span class="line"><span class="function">std::shared_ptr&lt;NativeModule&gt; <span class="title">WasmCodeManager::NewNativeModule</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    Isolate* isolate, <span class="type">const</span> WasmFeatures&amp; enabled, <span class="type">size_t</span> code_size_estimate,</span></span></span><br><span class="line"><span class="params"><span class="function">    std::shared_ptr&lt;<span class="type">const</span> WasmModule&gt; <span class="keyword">module</span>)</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line">  <span class="comment">// Try up to two times; getting rid of dead JSArrayBuffer allocations might</span></span><br><span class="line">  <span class="comment">// require two GCs because the first GC maybe incremental and may have</span></span><br><span class="line">  <span class="comment">// floating garbage.</span></span><br><span class="line">  <span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">int</span> kAllocationRetries = <span class="number">2</span>;</span><br><span class="line">  VirtualMemory code_space;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> retries = <span class="number">0</span>;; ++retries) &#123;</span><br><span class="line">    code_space = <span class="built_in">TryAllocate</span>(code_vmem_size);</span><br><span class="line">    <span class="keyword">if</span> (code_space.<span class="built_in">IsReserved</span>()) <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> (retries == kAllocationRetries) &#123;</span><br><span class="line">      V8::<span class="built_in">FatalProcessOutOfMemory</span>(isolate, <span class="string">&quot;NewNativeModule&quot;</span>);</span><br><span class="line">      <span class="built_in">UNREACHABLE</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Run one GC, then try the allocation again.</span></span><br><span class="line">    isolate-&gt;<span class="built_in">heap</span>()-&gt;<span class="built_in">MemoryPressureNotification</span>(MemoryPressureLevel::kCritical,</span><br><span class="line">                                                <span class="literal">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>When a WebAssembly module is constructed, <code>code_space</code> for the WebAssembly code is allocated.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* src/wasm/wasm-code-manager.cc:1545-1641 */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">NativeModule::AddCodeSpaceLocked</span><span class="params">(base::AddressRegion region)</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line">  <span class="keyword">if</span> (needs_jump_table) &#123;</span><br><span class="line">    jump_table = <span class="built_in">CreateEmptyJumpTableInRegionLocked</span>(</span><br><span class="line">        JumpTableAssembler::<span class="built_in">SizeForNumberOfSlots</span>(num_wasm_functions), region);</span><br><span class="line">    <span class="built_in">CHECK</span>(region.<span class="built_in">contains</span>(jump_table-&gt;<span class="built_in">instruction_start</span>()));</span><br><span class="line">  &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>jump_table</code> is created at the very front of the code space. The jump table determines the execution flow of functions in the WebAssembly module.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* src/wasm/wasm-code-manager.cc:1877-1934 */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">WasmCodeManager::Commit</span><span class="params">(base::AddressRegion region)</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line">  PageAllocator::Permission permission = PageAllocator::kReadWriteExecute;</span><br><span class="line"></span><br><span class="line">  <span class="type">bool</span> success;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">MemoryProtectionKeysEnabled</span>()) &#123;</span><br><span class="line">    <span class="built_in">TRACE_HEAP</span>(</span><br><span class="line">        <span class="string">&quot;Setting rwx permissions and memory protection key %d for 0x%&quot;</span> PRIxPTR</span><br><span class="line">        <span class="string">&quot;:0x%&quot;</span> PRIxPTR <span class="string">&quot;\n&quot;</span>,</span><br><span class="line">        memory_protection_key_, region.<span class="built_in">begin</span>(), region.<span class="built_in">end</span>());</span><br><span class="line">    success = <span class="built_in">SetPermissionsAndMemoryProtectionKey</span>(</span><br><span class="line">        <span class="built_in">GetPlatformPageAllocator</span>(), region, permission, memory_protection_key_);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">TRACE_HEAP</span>(<span class="string">&quot;Setting rwx permissions for 0x%&quot;</span> PRIxPTR <span class="string">&quot;:0x%&quot;</span> PRIxPTR <span class="string">&quot;\n&quot;</span>,</span><br><span class="line">               region.<span class="built_in">begin</span>(), region.<span class="built_in">end</span>());</span><br><span class="line">    success = <span class="built_in">SetPermissions</span>(<span class="built_in">GetPlatformPageAllocator</span>(), region.<span class="built_in">begin</span>(),</span><br><span class="line">                             region.<span class="built_in">size</span>(), permission);</span><br><span class="line">  &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The code space permission is set to RWX because compiled WebAssembly code has to be written to and executed in this space.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(; test.wat ;)</span><br><span class="line"></span><br><span class="line">(module</span><br><span class="line">  (func $f1 (export &quot;f1&quot;))</span><br><span class="line">  (func $f2 (export &quot;f2&quot;))</span><br><span class="line">  (func $f3 (export &quot;f3&quot;))</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><code>test.wat</code> defines a WebAssembly module containing three functions, all of which are exported to JavaScript.</p>
<p><img src="/2023/04/29/v8sbx-ab-1/4.png"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> wasm_src = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">0</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">109</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">96</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">16</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">102</span>, <span class="number">49</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">102</span>, <span class="number">50</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">102</span>, <span class="number">51</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">10</span>, <span class="number">10</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">11</span>]);</span><br><span class="line"><span class="keyword">let</span> wasm_module = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(wasm_src);</span><br></pre></td></tr></table></figure>

<p><img src="/2023/04/29/v8sbx-ab-1/5.png"></p>
<p>The jump table consists of <code>jmp</code> instructions, each of which corresponds to a function in the module.</p>
<p>We can access the exported functions with <a target="_blank" rel="external nofollow noopener noreferrer" href="https://developer.mozilla.org/docs/WebAssembly/Reference/JavaScript_interface/Instance/exports"><code>WebAssembly.Instance.prototype.exports</code></a>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> wasm_instance = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(wasm_module);</span><br><span class="line">% <span class="title class_">DebugPrint</span>(wasm_instance.<span class="property">exports</span>);</span><br></pre></td></tr></table></figure>

<p><img src="/2023/04/29/v8sbx-ab-1/6.png"></p>
<p>Each function is managed by <code>JSFunction</code> class, like any other function in JavaScript.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* src/objects/js-function.tq:20-31 */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// This class does not use the generated verifier, so if you change anything</span></span><br><span class="line"><span class="comment">// here, please also update JSFunctionVerify in objects-debug.cc.</span></span><br><span class="line">@highestInstanceTypeWithinParentClassRange</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">class</span> <span class="title class_">JSFunction</span> extends JSFunctionOrBoundFunction &#123;</span><br><span class="line">  shared_function_info: SharedFunctionInfo;</span><br><span class="line">  context: Context;</span><br><span class="line">  feedback_cell: FeedbackCell;</span><br><span class="line">  @<span class="keyword">if</span>(V8_EXTERNAL_CODE_SPACE) code: CodeDataContainer;</span><br><span class="line">  @ifnot(V8_EXTERNAL_CODE_SPACE) code: Code;</span><br><span class="line">  <span class="comment">// Space for the following field may or may not be allocated.</span></span><br><span class="line">  prototype_or_initial_map: JSReceiver|Map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>JSFunction</code> has an accessor named <code>code</code> pointing to <code>CodeDataContainer</code>.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* src/objects/code.h:41-214 */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// CodeDataContainer is a container for all mutable fields associated with its</span></span><br><span class="line"><span class="comment">// referencing &#123;Code&#125; object. Since &#123;Code&#125; objects reside on write-protected</span></span><br><span class="line"><span class="comment">// pages within the heap, its header fields need to be immutable. There always</span></span><br><span class="line"><span class="comment">// is a 1-to-1 relation between &#123;Code&#125; and &#123;CodeDataContainer&#125;, the referencing</span></span><br><span class="line"><span class="comment">// field &#123;Code::code_data_container&#125; itself is immutable.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CodeDataContainer</span> : <span class="keyword">public</span> HeapObject &#123;</span><br><span class="line">...</span><br><span class="line">  <span class="comment">// Cached value of code().InstructionStart().</span></span><br><span class="line">  <span class="comment">// Available only when V8_EXTERNAL_CODE_SPACE is defined.</span></span><br><span class="line">  <span class="built_in">DECL_GETTER</span>(code_entry_point, Address)</span><br><span class="line">...</span><br><span class="line">  <span class="comment">// Alias for code_entry_point to make it API compatible with Code.</span></span><br><span class="line">  <span class="function"><span class="keyword">inline</span> Address <span class="title">InstructionStart</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Alias for code_entry_point to make it API compatible with Code.</span></span><br><span class="line">  <span class="function"><span class="keyword">inline</span> Address <span class="title">raw_instruction_start</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Alias for code_entry_point to make it API compatible with Code.</span></span><br><span class="line">  <span class="function"><span class="keyword">inline</span> Address <span class="title">entry</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>CodeDataContainer</code> has an accessor named <code>code_entry_point</code> that points to where the instruction pointer moves when the function is called.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">% <span class="title class_">DebugPrint</span>(wasm_instance.<span class="property">exports</span>.<span class="property">f3</span>);</span><br></pre></td></tr></table></figure>

<p><img src="/2023/04/29/v8sbx-ab-1/7.png"></p>
<p><img src="/2023/04/29/v8sbx-ab-1/8.png"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wasm_instance.<span class="property">exports</span>.<span class="title function_">f3</span>();</span><br></pre></td></tr></table></figure>

<p><img src="/2023/04/29/v8sbx-ab-1/9.png"></p>
<p>At this point, <code>rdi</code> holds the address of the <code>Function</code> object. The instructions from here are responsible for getting the call target corresponding to the function called.</p>
<p><img src="/2023/04/29/v8sbx-ab-1/10.png"></p>
<p><img src="/2023/04/29/v8sbx-ab-1/11.png"></p>
<p><img src="/2023/04/29/v8sbx-ab-1/12.png"></p>
<p><img src="/2023/04/29/v8sbx-ab-1/13.png"></p>
<p><img src="/2023/04/29/v8sbx-ab-1/14.png"></p>
<p>Eventually, the instruction pointer moves to the third entry of the jump table. It corresponds to <code>f3()</code>, which is the third function in the module.</p>
<h2 id="Exploitation"><a href="#Exploitation" class="headerlink" title="Exploitation"></a>Exploitation</h2><h3 id="Get-address-of-WebAssembly-code-space"><a href="#Get-address-of-WebAssembly-code-space" class="headerlink" title="Get address of WebAssembly code space"></a>Get address of WebAssembly code space</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* src/wasm/wasm-objects.h:316-533 */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Representation of a WebAssembly.Instance JavaScript-level object.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">V8_EXPORT_PRIVATE</span> WasmInstanceObject : <span class="keyword">public</span> JSObject &#123;</span><br><span class="line">...</span><br><span class="line">  <span class="built_in">DECL_PRIMITIVE_ACCESSORS</span>(jump_table_start, Address)</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">// Layout description.</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WASM_INSTANCE_OBJECT_FIELDS(V)                                    \</span></span><br><span class="line"><span class="meta">...</span></span><br><span class="line">  <span class="built_in">V</span>(kJumpTableStartOffset, kSystemPointerSize)                            \</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>WasmInstanceObject</code> has an accessor named <code>jump_table_start</code> that points to the jump table of the corresponding WebAssembly module. The jump table is located at the very front of the WebAssembly code space, so the address of the jump table is identical to that of the code space.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">% <span class="title class_">DebugPrint</span>(wasm_instance);</span><br></pre></td></tr></table></figure>

<p><img src="/2023/04/29/v8sbx-ab-1/15.png"></p>
<p><img src="/2023/04/29/v8sbx-ab-1/16.png"></p>
<p>We can obtain the address of the <code>WasmInstanceObject</code> using <code>addrof()</code> primitive, and read the value stored in <code>jump_table_start</code> field to get the address of the code space.</p>
<h3 id="Write-shellcode-to-WebAssembly-code-space"><a href="#Write-shellcode-to-WebAssembly-code-space" class="headerlink" title="Write shellcode to WebAssembly code space"></a>Write shellcode to WebAssembly code space</h3><p>We can obtain the address of an <code>ArrayBuffer</code> using <code>addrof()</code> primitive and overwrite <code>backing_store</code> field with an arbitrary 8-byte address that points to where we want to read from or write to. The address doesn’t have to be inside the V8 sandbox, so that we can perform unsandboxed AAR&#x2F;AAW via this corrupted <code>ArrayBuffer</code>.</p>
<p>Using the unsandboxed AAW, we can write our shellcode to the WebAssembly code space. The code space has both write and execute permissions, allowing us to execute our shellcode later.</p>
<h3 id="Execute-shellcode"><a href="#Execute-shellcode" class="headerlink" title="Execute shellcode"></a>Execute shellcode</h3><p>Calling the exported function moves the instruction pointer to the WebAssembly jump table, where our shellcode lies.</p>
<p><a href="pwn.wat"><code>pwn.wat</code></a> <a href="shellcode.py"><code>shellcode.py</code></a> <a href="pwn.js"><code>pwn.js</code></a></p>
<p><img src="/2023/04/29/v8sbx-ab-1/pwn.png"></p>
<h2 id="Patch"><a href="#Patch" class="headerlink" title="Patch"></a>Patch</h2><blockquote>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/v8/v8/commit/f759872d52093d1ac2b531f7e8fa956264b57ad9">[wasm] Ship code protection via mprotect</a> (Feb 15, 2022)</p>
</blockquote>

  </div>
</article>


    <div class="blog-post-comments">
        <div id="utterances_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/categories/">Category</a></li>
        
          <li><a href="/tags/">Tag</a></li>
        
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Setup"><span class="toc-number">1.</span> <span class="toc-text">Setup</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Analysis"><span class="toc-number">2.</span> <span class="toc-text">Analysis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Backing-store-of-ArrayBuffer"><span class="toc-number">2.1.</span> <span class="toc-text">Backing store of ArrayBuffer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Execution-flow-of-WebAssembly-function"><span class="toc-number">2.2.</span> <span class="toc-text">Execution flow of WebAssembly function</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exploitation"><span class="toc-number">3.</span> <span class="toc-text">Exploitation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Get-address-of-WebAssembly-code-space"><span class="toc-number">3.1.</span> <span class="toc-text">Get address of WebAssembly code space</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Write-shellcode-to-WebAssembly-code-space"><span class="toc-number">3.2.</span> <span class="toc-text">Write shellcode to WebAssembly code space</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Execute-shellcode"><span class="toc-number">3.3.</span> <span class="toc-text">Execute shellcode</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Patch"><span class="toc-number">4.</span> <span class="toc-text">Patch</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://www.facebook.com/sharer.php?u=https://aaronsjcho.github.io/2023/04/29/v8sbx-ab-1/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="https://twitter.com/share?url=https://aaronsjcho.github.io/2023/04/29/v8sbx-ab-1/&text=Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://www.linkedin.com/shareArticle?url=https://aaronsjcho.github.io/2023/04/29/v8sbx-ab-1/&title=Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="https://pinterest.com/pin/create/bookmarklet/?url=https://aaronsjcho.github.io/2023/04/29/v8sbx-ab-1/&is_video=false&description=Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)&body=Check out this article: https://aaronsjcho.github.io/2023/04/29/v8sbx-ab-1/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="https://getpocket.com/save?url=https://aaronsjcho.github.io/2023/04/29/v8sbx-ab-1/&title=Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://reddit.com/submit?url=https://aaronsjcho.github.io/2023/04/29/v8sbx-ab-1/&title=Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://www.stumbleupon.com/submit?url=https://aaronsjcho.github.io/2023/04/29/v8sbx-ab-1/&title=Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://digg.com/submit?url=https://aaronsjcho.github.io/2023/04/29/v8sbx-ab-1/&title=Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://www.tumblr.com/share/link?url=https://aaronsjcho.github.io/2023/04/29/v8sbx-ab-1/&name=Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="https://news.ycombinator.com/submitlink?u=https://aaronsjcho.github.io/2023/04/29/v8sbx-ab-1/&t=Escaping V8 Sandbox via Backing Store of ArrayBuffer and WebAssembly Code Space: Part 1 (V8 &lt; 10.0.138)"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2019-2025
    Seongjoon Cho
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/categories/">Category</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'">


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

    <script type="text/javascript">
      var utterances_repo = 'aaronsjcho/aaronsjcho.github.io';
      var utterances_issue_term = 'pathname';
      var utterances_label = 'comment';
      var utterances_theme = 'github-dark';

      (function(){
          var script = document.createElement('script');

          script.src = 'https://utteranc.es/client.js';
          script.setAttribute('repo', utterances_repo);
          script.setAttribute('issue-term', 'pathname');
          script.setAttribute('label', utterances_label);
          script.setAttribute('theme', utterances_theme);
          script.setAttribute('crossorigin', 'anonymous');
          script.async = true;
          (document.getElementById('utterances_thread')).appendChild(script);
      }());
  </script>

</body>
</html>
