<!DOCTYPE html>
<html lang="en">
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
    <meta name="description" content="Escaping the V8 Sandbox by Overwriting WebAssembly Jump Table via TypedArray or ArrayBuffer (V8 &lt; 10.0.138) Escaping the V8 Sandbox by Overwriting WebAssembly Jump Table via TypedArray or ArrayBuf">
<meta property="og:type" content="article">
<meta property="og:title" content="Escaping the V8 Sandbox by Overwriting WebAssembly Jump Table via TypedArray or ArrayBuffer: Part 2 (10.0.138 &lt;&#x3D; V8 &lt; 10.3.163)">
<meta property="og:url" content="https://aaronsjcho.github.io/escaping-the-v8-sandbox-by-overwriting-webassembly-jump-table-via-typedarray-or-arraybuffer-part-2/index.html">
<meta property="og:site_name" content="Aaron&#39;s Note">
<meta property="og:description" content="Escaping the V8 Sandbox by Overwriting WebAssembly Jump Table via TypedArray or ArrayBuffer (V8 &lt; 10.0.138) Escaping the V8 Sandbox by Overwriting WebAssembly Jump Table via TypedArray or ArrayBuf">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://aaronsjcho.github.io/escaping-the-v8-sandbox-by-overwriting-webassembly-jump-table-via-typedarray-or-arraybuffer-part-2/1.png">
<meta property="og:image" content="https://aaronsjcho.github.io/escaping-the-v8-sandbox-by-overwriting-webassembly-jump-table-via-typedarray-or-arraybuffer-part-2/2.png">
<meta property="og:image" content="https://aaronsjcho.github.io/escaping-the-v8-sandbox-by-overwriting-webassembly-jump-table-via-typedarray-or-arraybuffer-part-2/3.png">
<meta property="og:image" content="https://aaronsjcho.github.io/escaping-the-v8-sandbox-by-overwriting-webassembly-jump-table-via-typedarray-or-arraybuffer-part-2/4.png">
<meta property="og:image" content="https://aaronsjcho.github.io/escaping-the-v8-sandbox-by-overwriting-webassembly-jump-table-via-typedarray-or-arraybuffer-part-2/pwn_ta.png">
<meta property="og:image" content="https://aaronsjcho.github.io/escaping-the-v8-sandbox-by-overwriting-webassembly-jump-table-via-typedarray-or-arraybuffer-part-2/pwn_ab.png">
<meta property="article:published_time" content="2023-04-30T03:00:00.000Z">
<meta property="article:modified_time" content="2026-01-24T11:08:31.833Z">
<meta property="article:author" content="Seongjoon (Aaron) Cho">
<meta property="article:tag" content="browser">
<meta property="article:tag" content="chromium">
<meta property="article:tag" content="v8">
<meta property="article:tag" content="v8sbx">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://aaronsjcho.github.io/escaping-the-v8-sandbox-by-overwriting-webassembly-jump-table-via-typedarray-or-arraybuffer-part-2/1.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Escaping the V8 Sandbox by Overwriting WebAssembly Jump Table via TypedArray or ArrayBuffer: Part 2 (10.0.138 &lt;= V8 &lt; 10.3.163)</title>
    <!-- async scripts -->
    <!-- Google Analytics -->

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-TXRLJ2S4LP"></script>
  <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-TXRLJ2S4LP');
  </script>


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 8.1.1"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/categories/">Category</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" aria-label="Next post" href="/escaping-the-v8-sandbox-by-overwriting-webassembly-jump-table-via-typedarray-or-arraybuffer/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://www.facebook.com/sharer.php?u=https://aaronsjcho.github.io/escaping-the-v8-sandbox-by-overwriting-webassembly-jump-table-via-typedarray-or-arraybuffer-part-2/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="https://twitter.com/share?url=https://aaronsjcho.github.io/escaping-the-v8-sandbox-by-overwriting-webassembly-jump-table-via-typedarray-or-arraybuffer-part-2/&text=Escaping the V8 Sandbox by Overwriting WebAssembly Jump Table via TypedArray or ArrayBuffer: Part 2 (10.0.138 &lt;= V8 &lt; 10.3.163)"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://www.linkedin.com/shareArticle?url=https://aaronsjcho.github.io/escaping-the-v8-sandbox-by-overwriting-webassembly-jump-table-via-typedarray-or-arraybuffer-part-2/&title=Escaping the V8 Sandbox by Overwriting WebAssembly Jump Table via TypedArray or ArrayBuffer: Part 2 (10.0.138 &lt;= V8 &lt; 10.3.163)"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="https://pinterest.com/pin/create/bookmarklet/?url=https://aaronsjcho.github.io/escaping-the-v8-sandbox-by-overwriting-webassembly-jump-table-via-typedarray-or-arraybuffer-part-2/&is_video=false&description=Escaping the V8 Sandbox by Overwriting WebAssembly Jump Table via TypedArray or ArrayBuffer: Part 2 (10.0.138 &lt;= V8 &lt; 10.3.163)"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Escaping the V8 Sandbox by Overwriting WebAssembly Jump Table via TypedArray or ArrayBuffer: Part 2 (10.0.138 &lt;= V8 &lt; 10.3.163)&body=Check out this article: https://aaronsjcho.github.io/escaping-the-v8-sandbox-by-overwriting-webassembly-jump-table-via-typedarray-or-arraybuffer-part-2/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="https://getpocket.com/save?url=https://aaronsjcho.github.io/escaping-the-v8-sandbox-by-overwriting-webassembly-jump-table-via-typedarray-or-arraybuffer-part-2/&title=Escaping the V8 Sandbox by Overwriting WebAssembly Jump Table via TypedArray or ArrayBuffer: Part 2 (10.0.138 &lt;= V8 &lt; 10.3.163)"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://reddit.com/submit?url=https://aaronsjcho.github.io/escaping-the-v8-sandbox-by-overwriting-webassembly-jump-table-via-typedarray-or-arraybuffer-part-2/&title=Escaping the V8 Sandbox by Overwriting WebAssembly Jump Table via TypedArray or ArrayBuffer: Part 2 (10.0.138 &lt;= V8 &lt; 10.3.163)"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://www.stumbleupon.com/submit?url=https://aaronsjcho.github.io/escaping-the-v8-sandbox-by-overwriting-webassembly-jump-table-via-typedarray-or-arraybuffer-part-2/&title=Escaping the V8 Sandbox by Overwriting WebAssembly Jump Table via TypedArray or ArrayBuffer: Part 2 (10.0.138 &lt;= V8 &lt; 10.3.163)"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://digg.com/submit?url=https://aaronsjcho.github.io/escaping-the-v8-sandbox-by-overwriting-webassembly-jump-table-via-typedarray-or-arraybuffer-part-2/&title=Escaping the V8 Sandbox by Overwriting WebAssembly Jump Table via TypedArray or ArrayBuffer: Part 2 (10.0.138 &lt;= V8 &lt; 10.3.163)"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://www.tumblr.com/share/link?url=https://aaronsjcho.github.io/escaping-the-v8-sandbox-by-overwriting-webassembly-jump-table-via-typedarray-or-arraybuffer-part-2/&name=Escaping the V8 Sandbox by Overwriting WebAssembly Jump Table via TypedArray or ArrayBuffer: Part 2 (10.0.138 &lt;= V8 &lt; 10.3.163)&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="https://news.ycombinator.com/submitlink?u=https://aaronsjcho.github.io/escaping-the-v8-sandbox-by-overwriting-webassembly-jump-table-via-typedarray-or-arraybuffer-part-2/&t=Escaping the V8 Sandbox by Overwriting WebAssembly Jump Table via TypedArray or ArrayBuffer: Part 2 (10.0.138 &lt;= V8 &lt; 10.3.163)"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Setup"><span class="toc-number">1.</span> <span class="toc-text">Setup</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Analysis"><span class="toc-number">2.</span> <span class="toc-text">Analysis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#WebAssembly-Code-Protection"><span class="toc-number">2.1.</span> <span class="toc-text">WebAssembly Code Protection</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exploitation"><span class="toc-number">3.</span> <span class="toc-text">Exploitation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Obtaining-address-of-FLAG-wasm-write-protect-code-memory"><span class="toc-number">3.1.</span> <span class="toc-text">Obtaining address of FLAG_wasm_write_protect_code_memory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Using-TypedArray"><span class="toc-number">3.2.</span> <span class="toc-text">Using TypedArray</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Using-ArrayBuffer"><span class="toc-number">3.3.</span> <span class="toc-text">Using ArrayBuffer</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Bisection"><span class="toc-number">4.</span> <span class="toc-text">Bisection</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Patch"><span class="toc-number">5.</span> <span class="toc-text">Patch</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        Escaping the V8 Sandbox by Overwriting WebAssembly Jump Table via TypedArray or ArrayBuffer: Part 2 (10.0.138 &lt;= V8 &lt; 10.3.163)
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">Seongjoon (Aaron) Cho</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-04-30T03:00:00.000Z" class="dt-published" itemprop="datePublished">2023-04-30</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/n-day/">n-day</a> › <a class="category-link" href="/categories/n-day/exploitation/">exploitation</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/browser/" rel="tag">browser</a>, <a class="p-category" href="/tags/chromium/" rel="tag">chromium</a>, <a class="p-category" href="/tags/v8/" rel="tag">v8</a>, <a class="p-category" href="/tags/v8sbx/" rel="tag">v8sbx</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <ol>
<li><a href="/escaping-the-v8-sandbox-by-overwriting-webassembly-jump-table-via-typedarray-or-arraybuffer/" title="Escaping the V8 Sandbox by Overwriting WebAssembly Jump Table via TypedArray or ArrayBuffer (V8 &lt; 10.0.138)">Escaping the V8 Sandbox by Overwriting WebAssembly Jump Table via TypedArray or ArrayBuffer (V8 &lt; 10.0.138)</a></li>
<li><strong><a href="/escaping-the-v8-sandbox-by-overwriting-webassembly-jump-table-via-typedarray-or-arraybuffer-part-2/" title="Escaping the V8 Sandbox by Overwriting WebAssembly Jump Table via TypedArray or ArrayBuffer: Part 2 (10.0.138 &lt;&#x3D; V8 &lt; 10.3.163)">Escaping the V8 Sandbox by Overwriting WebAssembly Jump Table via TypedArray or ArrayBuffer: Part 2 (10.0.138 &lt;&#x3D; V8 &lt; 10.3.163)</a></strong></li>
</ol>
<p>The <a target="_blank" rel="external nofollow noopener noreferrer" href="https://chromium.googlesource.com/v8/v8.git/+/f759872d52093d1ac2b531f7e8fa956264b57ad9">patch</a> mitigating the exploit from Part 1 was designed to prevent overwriting the WebAssembly code space. However, because we still have access to an arbitrary address write primitive outside the V8 sandbox, we can simply overwrite the flag at runtime to disable this protection. This effectively reverts the environment to the state described in Part 1, restoring our ability to execute arbitrary code.</p>
<h2 id="Setup"><a href="#Setup" class="headerlink" title="Setup"></a>Setup</h2><ul>
<li>Ubuntu 20.04</li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://chromium.googlesource.com/v8/v8.git/+/f759872d52093d1ac2b531f7e8fa956264b57ad9">[wasm] Ship code protection via mprotect</a> (Feb 15, 2022)</li>
</ul>
<p>Place <a href="v8setup.py"><code>v8setup.py</code></a> and <a href="sandbox.diff"><code>sandbox.diff</code></a> in your working directory and run <code>v8setup.py</code>.</p>
<blockquote><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://chromium.googlesource.com/v8/v8.git/+/4a12cb1022ba335ce087dcfe31b261355524b3bf">[sandbox] Add new Memory Corruption API</a> (May 20, 2022)<br>When enabled, this API exposes a new global ‘Sandbox’ object which contains a number of functions and objects that in effect emulate typical memory corruption primitives constructed by exploits. In particular, the ‘MemoryView’ constructor can construct ArrayBuffers instances that can corrupt arbitrary memory inside the sandbox. Further, the getAddressOf(obj) and getSizeInBytesOf(obj) functions can be used respectively to obtain the address (relative to the base of the sandbox) and size of any HeapObject that can be accessed from JavaScript.<br>This API is useful for testing the sandbox, for example to facilitate developing PoC sandbox escapes or writing regression tests. In the future, it may also be used by custom V8 sandbox fuzzers.</p>
</blockquote>

<p><code>sandbox.diff</code> corresponds to the commit above, which introduces a new memory corruption API. This allows us to simulate sandboxed exploit primitives for testing purposes.</p>
<h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><h3 id="WebAssembly-Code-Protection"><a href="#WebAssembly-Code-Protection" class="headerlink" title="WebAssembly Code Protection"></a>WebAssembly Code Protection</h3><figure class="highlight c++"><figcaption><span>src&#x2F;wasm&#x2F;code-space-access.cc</span></figcaption><table><tr><td class="gutter"><pre><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// static</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CodeSpaceWriteScope::SetExecutable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span>* code_manager = <span class="built_in">GetWasmCodeManager</span>();</span><br><span class="line">  <span class="keyword">if</span> (code_manager-&gt;<span class="built_in">MemoryProtectionKeysEnabled</span>()) &#123;</span><br><span class="line">    <span class="built_in">DCHECK</span>(FLAG_wasm_memory_protection_keys);</span><br><span class="line">    code_manager-&gt;<span class="built_in">SetThreadWritable</span>(<span class="literal">false</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (FLAG_wasm_write_protect_code_memory) &#123;</span><br><span class="line marked">    current_native_module_-&gt;<span class="built_in">RemoveWriter</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>If <code>FLAG_wasm_write_protect_code_memory</code> is set to true, <code>CodeSpaceWriteScope::SetExecutable()</code> calls <code>NativeModule::RemoveWriter()</code> to revoke write permissions whenever write access to the WebAssembly code space is no longer needed.</p>
<figure class="highlight c++"><figcaption><span>src&#x2F;wasm&#x2F;wasm-code-manager.cc</span></figcaption><table><tr><td class="gutter"><pre><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">WasmCodeAllocator::MakeWritable</span><span class="params">(base::AddressRegion region)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!protect_code_memory_) <span class="keyword">return</span>;</span><br><span class="line">  <span class="built_in">DCHECK_LT</span>(<span class="number">0</span>, writers_count_);</span><br><span class="line">  <span class="built_in">DCHECK</span>(!region.<span class="built_in">is_empty</span>());</span><br><span class="line">  v8::PageAllocator* page_allocator = <span class="built_in">GetPlatformPageAllocator</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Align to commit page size.</span></span><br><span class="line">  <span class="type">size_t</span> commit_page_size = page_allocator-&gt;<span class="built_in">CommitPageSize</span>();</span><br><span class="line">  <span class="built_in">DCHECK</span>(base::bits::<span class="built_in">IsPowerOfTwo</span>(commit_page_size));</span><br><span class="line">  Address begin = <span class="built_in">RoundDown</span>(region.<span class="built_in">begin</span>(), commit_page_size);</span><br><span class="line">  Address end = <span class="built_in">RoundUp</span>(region.<span class="built_in">end</span>(), commit_page_size);</span><br><span class="line">  region = base::<span class="built_in">AddressRegion</span>(begin, end - begin);</span><br><span class="line"></span><br><span class="line marked">  <span class="built_in">InsertIntoWritableRegions</span>(region, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Write permissions are restored only when necessary. <code>WasmCodeAllocator::MakeWritable()</code> calculates the memory range requiring write access and calls <code>WasmCodeAllocator::InsertIntoWritableRegions()</code>.</p>
<figure class="highlight c++"><figcaption><span>src&#x2F;wasm&#x2F;wasm-code-manager.cc</span></figcaption><table><tr><td class="gutter"><pre><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br></pre></td><td class="code"><pre><span class="line">new_writable_memory += region.<span class="built_in">size</span>();</span><br><span class="line"><span class="keyword">if</span> (switch_to_writable) &#123;</span><br><span class="line">  <span class="keyword">for</span> (base::AddressRegion split_range :</span><br><span class="line">       <span class="built_in">SplitRangeByReservationsIfNeeded</span>(region, owned_code_space_)) &#123;</span><br><span class="line">    <span class="built_in">TRACE_HEAP</span>(<span class="string">&quot;Set 0x%&quot;</span> V8PRIxPTR <span class="string">&quot;:0x%&quot;</span> V8PRIxPTR <span class="string">&quot; to RWX\n&quot;</span>,</span><br><span class="line">               split_range.<span class="built_in">begin</span>(), split_range.<span class="built_in">end</span>());</span><br><span class="line marked">    <span class="built_in">CHECK</span>(<span class="built_in">SetPermissions</span>(page_allocator, split_range.<span class="built_in">begin</span>(),</span><br><span class="line marked">                         split_range.<span class="built_in">size</span>(),</span><br><span class="line marked">                         PageAllocator::kReadWriteExecute));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>WasmCodeAllocator::InsertIntoWritableRegions()</code> calls <code>SetPermissions()</code> to set the region’s permissions to RWX.</p>
<p>This mechanism prevents us from writing shellcode to the code space as we did in Part 1, since write permissions likely won’t be active at the moment we attempt our write. However, <code>CodeSpaceWriteScope::SetExecutable()</code> checks <code>FLAG_wasm_write_protect_code_memory</code> every time it is called. If we overwrite this flag to <code>false</code> at runtime, the protection is immediately disabled, allowing us to achieve arbitrary code execution exactly as we did in Part 1.</p>
<h2 id="Exploitation"><a href="#Exploitation" class="headerlink" title="Exploitation"></a>Exploitation</h2><h3 id="Obtaining-address-of-FLAG-wasm-write-protect-code-memory"><a href="#Obtaining-address-of-FLAG-wasm-write-protect-code-memory" class="headerlink" title="Obtaining address of FLAG_wasm_write_protect_code_memory"></a>Obtaining address of FLAG_wasm_write_protect_code_memory</h3><figure class="highlight c++"><figcaption><span>src&#x2F;wasm&#x2F;wasm-objects.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">339</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">DECL_PRIMITIVE_ACCESSORS</span>(isolate_root, Address)</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><figcaption><span>src&#x2F;wasm&#x2F;wasm-objects.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">385</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">V</span>(kIsolateRootOffset, kSystemPointerSize)                               \</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><figcaption><span>src&#x2F;execution&#x2F;isolate.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">2052</span><br><span class="line">2053</span><br><span class="line">2054</span><br><span class="line">2055</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This class contains a collection of data accessible from both C++ runtime</span></span><br><span class="line"><span class="comment">// and compiled code (including assembly stubs, builtins, interpreter bytecode</span></span><br><span class="line"><span class="comment">// handlers and optimized code).</span></span><br><span class="line">IsolateData isolate_data_;</span><br></pre></td></tr></table></figure>

<p>The <code>WasmInstanceObject</code> class has an accessor, <code>isolate_root</code>, which points to <code>Isolate::isolate_data_</code>.</p>
<p><img src="/escaping-the-v8-sandbox-by-overwriting-webassembly-jump-table-via-typedarray-or-arraybuffer-part-2/1.png"></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">d8.<span class="property">file</span>.<span class="title function_">execute</span>(<span class="string">&quot;v8/test/mjsunit/wasm/wasm-module-builder.js&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> builder = <span class="keyword">new</span> <span class="title class_">WasmModuleBuilder</span>();</span><br><span class="line">builder.<span class="title function_">addFunction</span>(<span class="string">&quot;f&quot;</span>, <span class="title function_">makeSig</span>([], [])).<span class="title function_">addBody</span>([]).<span class="title function_">exportFunc</span>();</span><br><span class="line"><span class="keyword">let</span> instance = builder.<span class="title function_">instantiate</span>();</span><br><span class="line">% <span class="title class_">DebugPrint</span>(instance);</span><br></pre></td></tr></table></figure>

<p><img src="/escaping-the-v8-sandbox-by-overwriting-webassembly-jump-table-via-typedarray-or-arraybuffer-part-2/2.png"></p>
<p><img src="/escaping-the-v8-sandbox-by-overwriting-webassembly-jump-table-via-typedarray-or-arraybuffer-part-2/3.png"></p>
<figure class="highlight c++"><figcaption><span>src&#x2F;execution&#x2F;isolate-data.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line">ExternalReferenceTable external_reference_table_;</span><br></pre></td></tr></table></figure>

<p>The <code>IsolateData</code> class contains <code>external_reference_table_</code>, which holds pointers to <code>d8</code> execution flags.</p>
<p><img src="/escaping-the-v8-sandbox-by-overwriting-webassembly-jump-table-via-typedarray-or-arraybuffer-part-2/4.png"></p>
<p>The order of the execution flags remains consistent as long as the V8 version does not change.</p>
<figure class="highlight c++"><figcaption><span>src&#x2F;flags&#x2F;flag-definitions.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">374</span><br><span class="line">375</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">DEFINE_BOOL</span>(builtin_subclassing, <span class="literal">true</span>,</span><br><span class="line">            <span class="string">&quot;subclassing support in built-in methods&quot;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><figcaption><span>src&#x2F;flags&#x2F;flag-definitions.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">940</span><br><span class="line">941</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">DEFINE_BOOL</span>(wasm_write_protect_code_memory, <span class="literal">true</span>,</span><br><span class="line">            <span class="string">&quot;write protect code memory on the wasm native heap with mprotect&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>Therefore, we can reliably calculate the address of <code>FLAG_wasm_write_protect_code_memory</code> by using a known flag address found in the <code>IsolateData::external_reference_table_</code>.</p>
<h3 id="Using-TypedArray"><a href="#Using-TypedArray" class="headerlink" title="Using TypedArray"></a>Using TypedArray</h3><p>The following scripts demonstrate the full exploit chain using <code>TypedArray</code>:</p>
<p><a href="shellcode.py"><code>shellcode.py</code></a> <a href="pwn_ta.js"><code>pwn_ta.js</code></a></p>
<p><img src="/escaping-the-v8-sandbox-by-overwriting-webassembly-jump-table-via-typedarray-or-arraybuffer-part-2/pwn_ta.png"></p>
<h3 id="Using-ArrayBuffer"><a href="#Using-ArrayBuffer" class="headerlink" title="Using ArrayBuffer"></a>Using ArrayBuffer</h3><p>Similarly, here is the implementation using <code>ArrayBuffer</code>:</p>
<p><a href="shellcode.py"><code>shellcode.py</code></a> <a href="pwn_ab.js"><code>pwn_ab.js</code></a></p>
<p><img src="/escaping-the-v8-sandbox-by-overwriting-webassembly-jump-table-via-typedarray-or-arraybuffer-part-2/pwn_ab.png"></p>
<h2 id="Bisection"><a href="#Bisection" class="headerlink" title="Bisection"></a>Bisection</h2><blockquote><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://chromium.googlesource.com/v8/v8.git/+/f759872d52093d1ac2b531f7e8fa956264b57ad9">[wasm] Ship code protection via mprotect</a> (Feb 15, 2022)<br>Even though this is not a perfect protection, it will make it harder to write to the wasm code space because it’s not permanently RWX.</p>
</blockquote>

<p>The patch above enables <code>wasm_write_protect_code_memory</code> by default.</p>
<h2 id="Patch"><a href="#Patch" class="headerlink" title="Patch"></a>Patch</h2><blockquote><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://chromium.googlesource.com/v8/v8.git/+/48481a671ac7fed873f8a7e7203862beb6d89abd">[sandbox] Enable sandboxed pointers on Desktop</a> (May 05, 2022)<br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://chromium.googlesource.com/v8/v8.git/+/c50b995e4b57558745aef9dda73dc58c57681811">Revert “[sandbox] Enable sandboxed pointers on Desktop”</a> (May 06, 2022)<br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://chromium.googlesource.com/v8/v8.git/+/31d7838094a853556f345367038fe13252ea9224">Reland “[sandbox] Enable sandboxed pointers on Desktop”</a> (May 06, 2022)<br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://chromium.googlesource.com/v8/v8.git/+/91ab0528f23aaf4d65ae86b7cafdcac65cff6c37">Revert “Reland “[sandbox] Enable sandboxed pointers on Desktop””</a> (May 06, 2022)<br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://chromium.googlesource.com/v8/v8.git/+/9a6a76bf13d3ca1c6788de193afc5513919dd0ed">Reland “Reland “[sandbox] Enable sandboxed pointers on Desktop””</a> (May 10, 2022)</p>
</blockquote>

<p>The commits above enabled <code>v8_enable_sandboxed_pointers</code> by default when <code>v8_enable_sandbox</code> is enabled. Consequently, the <code>external_pointer</code> of the <code>JSTypedArray</code> class is no longer stored as a full 8-byte pointer, and the <code>backing_store</code> pointer of the <code>JSArrayBuffer</code> class is now allocated within the V8 sandbox.</p>
<blockquote><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://chromium.googlesource.com/v8/v8.git/+/5b9401dde4532719220ac698eef7012cdd371903">[sandbox] Also enable the sandbox outside of Chromium builds</a> (Jun 17, 2022)<br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://chromium.googlesource.com/v8/v8.git/+/c878117fa0a848be0f011f410210ac4026baec05">Revert “[sandbox] Also enable the sandbox outside of Chromium builds”</a> (Jun 20, 2022)<br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://chromium.googlesource.com/v8/v8.git/+/a4d17470ab23b057327d614d032fc05ef70dd683">Reland “[sandbox] Also enable the sandbox outside of Chromium builds”</a> (Jun 21, 2022)<br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://chromium.googlesource.com/v8/v8.git/+/a7329344e52a0af3461aacaa8c538ddf8992e0d6">[sandbox] Disable the sandbox by default outside of Chromium builds</a> (Jul 19, 2022)<br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://chromium.googlesource.com/v8/v8.git/+/a8c27fcc9f9f15a0110a409190a2b514ec86e37f">[sandbox] Enable the sandbox by default in V8 builds</a> (Sep 23, 2022)</p>
</blockquote>

<p><code>v8_enable_sandbox</code> was enabled by default for standalone V8 builds in the commits above, while it was already enabled in Chromium builds in the following commit.</p>
<blockquote><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://chromium.googlesource.com/v8/v8.git/+/4fb3eae7afa2023057818d11faeefc031b78d444">Turn on v8_enable_virtual_memory_cage for Chromium builds</a> (Oct 4, 2021)</p>
</blockquote>

  </div>
</article>


    <div class="blog-post-comments">
        <div id="utterances_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/categories/">Category</a></li>
        
          <li><a href="/tags/">Tag</a></li>
        
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Setup"><span class="toc-number">1.</span> <span class="toc-text">Setup</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Analysis"><span class="toc-number">2.</span> <span class="toc-text">Analysis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#WebAssembly-Code-Protection"><span class="toc-number">2.1.</span> <span class="toc-text">WebAssembly Code Protection</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exploitation"><span class="toc-number">3.</span> <span class="toc-text">Exploitation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Obtaining-address-of-FLAG-wasm-write-protect-code-memory"><span class="toc-number">3.1.</span> <span class="toc-text">Obtaining address of FLAG_wasm_write_protect_code_memory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Using-TypedArray"><span class="toc-number">3.2.</span> <span class="toc-text">Using TypedArray</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Using-ArrayBuffer"><span class="toc-number">3.3.</span> <span class="toc-text">Using ArrayBuffer</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Bisection"><span class="toc-number">4.</span> <span class="toc-text">Bisection</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Patch"><span class="toc-number">5.</span> <span class="toc-text">Patch</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://www.facebook.com/sharer.php?u=https://aaronsjcho.github.io/escaping-the-v8-sandbox-by-overwriting-webassembly-jump-table-via-typedarray-or-arraybuffer-part-2/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="https://twitter.com/share?url=https://aaronsjcho.github.io/escaping-the-v8-sandbox-by-overwriting-webassembly-jump-table-via-typedarray-or-arraybuffer-part-2/&text=Escaping the V8 Sandbox by Overwriting WebAssembly Jump Table via TypedArray or ArrayBuffer: Part 2 (10.0.138 &lt;= V8 &lt; 10.3.163)"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://www.linkedin.com/shareArticle?url=https://aaronsjcho.github.io/escaping-the-v8-sandbox-by-overwriting-webassembly-jump-table-via-typedarray-or-arraybuffer-part-2/&title=Escaping the V8 Sandbox by Overwriting WebAssembly Jump Table via TypedArray or ArrayBuffer: Part 2 (10.0.138 &lt;= V8 &lt; 10.3.163)"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="https://pinterest.com/pin/create/bookmarklet/?url=https://aaronsjcho.github.io/escaping-the-v8-sandbox-by-overwriting-webassembly-jump-table-via-typedarray-or-arraybuffer-part-2/&is_video=false&description=Escaping the V8 Sandbox by Overwriting WebAssembly Jump Table via TypedArray or ArrayBuffer: Part 2 (10.0.138 &lt;= V8 &lt; 10.3.163)"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Escaping the V8 Sandbox by Overwriting WebAssembly Jump Table via TypedArray or ArrayBuffer: Part 2 (10.0.138 &lt;= V8 &lt; 10.3.163)&body=Check out this article: https://aaronsjcho.github.io/escaping-the-v8-sandbox-by-overwriting-webassembly-jump-table-via-typedarray-or-arraybuffer-part-2/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="https://getpocket.com/save?url=https://aaronsjcho.github.io/escaping-the-v8-sandbox-by-overwriting-webassembly-jump-table-via-typedarray-or-arraybuffer-part-2/&title=Escaping the V8 Sandbox by Overwriting WebAssembly Jump Table via TypedArray or ArrayBuffer: Part 2 (10.0.138 &lt;= V8 &lt; 10.3.163)"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://reddit.com/submit?url=https://aaronsjcho.github.io/escaping-the-v8-sandbox-by-overwriting-webassembly-jump-table-via-typedarray-or-arraybuffer-part-2/&title=Escaping the V8 Sandbox by Overwriting WebAssembly Jump Table via TypedArray or ArrayBuffer: Part 2 (10.0.138 &lt;= V8 &lt; 10.3.163)"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://www.stumbleupon.com/submit?url=https://aaronsjcho.github.io/escaping-the-v8-sandbox-by-overwriting-webassembly-jump-table-via-typedarray-or-arraybuffer-part-2/&title=Escaping the V8 Sandbox by Overwriting WebAssembly Jump Table via TypedArray or ArrayBuffer: Part 2 (10.0.138 &lt;= V8 &lt; 10.3.163)"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://digg.com/submit?url=https://aaronsjcho.github.io/escaping-the-v8-sandbox-by-overwriting-webassembly-jump-table-via-typedarray-or-arraybuffer-part-2/&title=Escaping the V8 Sandbox by Overwriting WebAssembly Jump Table via TypedArray or ArrayBuffer: Part 2 (10.0.138 &lt;= V8 &lt; 10.3.163)"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://www.tumblr.com/share/link?url=https://aaronsjcho.github.io/escaping-the-v8-sandbox-by-overwriting-webassembly-jump-table-via-typedarray-or-arraybuffer-part-2/&name=Escaping the V8 Sandbox by Overwriting WebAssembly Jump Table via TypedArray or ArrayBuffer: Part 2 (10.0.138 &lt;= V8 &lt; 10.3.163)&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="https://news.ycombinator.com/submitlink?u=https://aaronsjcho.github.io/escaping-the-v8-sandbox-by-overwriting-webassembly-jump-table-via-typedarray-or-arraybuffer-part-2/&t=Escaping the V8 Sandbox by Overwriting WebAssembly Jump Table via TypedArray or ArrayBuffer: Part 2 (10.0.138 &lt;= V8 &lt; 10.3.163)"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2019-2026
    Seongjoon (Aaron) Cho
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/categories/">Category</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'">


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

    <script type="text/javascript">
      var utterances_repo = 'aaronsjcho/aaronsjcho.github.io';
      var utterances_issue_term = 'pathname';
      var utterances_label = 'Comment';
      var utterances_theme = 'github-dark';

      (function(){
          var script = document.createElement('script');

          script.src = 'https://utteranc.es/client.js';
          script.setAttribute('repo', utterances_repo);
          script.setAttribute('issue-term', 'pathname');
          script.setAttribute('label', utterances_label);
          script.setAttribute('theme', utterances_theme);
          script.setAttribute('crossorigin', 'anonymous');
          script.async = true;
          var utterances_thread = document.getElementById('utterances_thread');
          if (utterances_thread) { utterances_thread.appendChild(script); }
      }());
  </script>

</body>
</html>
